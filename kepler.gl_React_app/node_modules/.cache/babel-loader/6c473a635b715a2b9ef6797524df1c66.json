{"ast":null,"code":"import { assembleShaders } from '@luma.gl/shadertools';\nimport { Program } from '@luma.gl/webgl';\nexport default class ProgramManager {\n  static getDefaultProgramManager(gl) {\n    gl.luma = gl.luma || {};\n    gl.luma.defaultProgramManager = gl.luma.defaultProgramManager || new ProgramManager(gl);\n    return gl.luma.defaultProgramManager;\n  }\n  constructor(gl) {\n    this.gl = gl;\n    this._programCache = {};\n    this._getUniforms = {};\n    this._registeredModules = {};\n    this._hookFunctions = [];\n    this._defaultModules = [];\n    this._hashes = {};\n    this._hashCounter = 0;\n    this.stateHash = 0;\n    this._useCounts = {};\n  }\n  addDefaultModule(module) {\n    if (!this._defaultModules.find(m => m.name === module.name)) {\n      this._defaultModules.push(module);\n    }\n    this.stateHash++;\n  }\n  removeDefaultModule(module) {\n    const moduleName = typeof module === 'string' ? module : module.name;\n    this._defaultModules = this._defaultModules.filter(m => m.name !== moduleName);\n    this.stateHash++;\n  }\n  addShaderHook(hook, opts) {\n    if (opts) {\n      hook = Object.assign(opts, {\n        hook\n      });\n    }\n    this._hookFunctions.push(hook);\n    this.stateHash++;\n  }\n  get() {\n    let props = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n    const {\n      vs = '',\n      fs = '',\n      defines = {},\n      inject = {},\n      varyings = [],\n      bufferMode = 0x8c8d,\n      transpileToGLSL100 = false\n    } = props;\n    const modules = this._getModuleList(props.modules);\n    const vsHash = this._getHash(vs);\n    const fsHash = this._getHash(fs);\n    const moduleHashes = modules.map(m => this._getHash(m.name)).sort();\n    const varyingHashes = varyings.map(v => this._getHash(v));\n    const defineKeys = Object.keys(defines).sort();\n    const injectKeys = Object.keys(inject).sort();\n    const defineHashes = [];\n    const injectHashes = [];\n    for (const key of defineKeys) {\n      defineHashes.push(this._getHash(key));\n      defineHashes.push(this._getHash(defines[key]));\n    }\n    for (const key of injectKeys) {\n      injectHashes.push(this._getHash(key));\n      injectHashes.push(this._getHash(inject[key]));\n    }\n    const hash = \"\".concat(vsHash, \"/\").concat(fsHash, \"D\").concat(defineHashes.join('/'), \"M\").concat(moduleHashes.join('/'), \"I\").concat(injectHashes.join('/'), \"V\").concat(varyingHashes.join('/'), \"H\").concat(this.stateHash, \"B\").concat(bufferMode).concat(transpileToGLSL100 ? 'T' : '');\n    if (!this._programCache[hash]) {\n      const assembled = assembleShaders(this.gl, {\n        vs,\n        fs,\n        modules,\n        inject,\n        defines,\n        hookFunctions: this._hookFunctions,\n        transpileToGLSL100\n      });\n      this._programCache[hash] = new Program(this.gl, {\n        hash,\n        vs: assembled.vs,\n        fs: assembled.fs,\n        varyings,\n        bufferMode\n      });\n      this._getUniforms[hash] = assembled.getUniforms || (x => {});\n      this._useCounts[hash] = 0;\n    }\n    this._useCounts[hash]++;\n    return this._programCache[hash];\n  }\n  getUniforms(program) {\n    return this._getUniforms[program.hash] || null;\n  }\n  release(program) {\n    const hash = program.hash;\n    this._useCounts[hash]--;\n    if (this._useCounts[hash] === 0) {\n      this._programCache[hash].delete();\n      delete this._programCache[hash];\n      delete this._getUniforms[hash];\n      delete this._useCounts[hash];\n    }\n  }\n  _getHash(key) {\n    if (this._hashes[key] === undefined) {\n      this._hashes[key] = this._hashCounter++;\n    }\n    return this._hashes[key];\n  }\n  _getModuleList() {\n    let appModules = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];\n    const modules = new Array(this._defaultModules.length + appModules.length);\n    const seen = {};\n    let count = 0;\n    for (let i = 0, len = this._defaultModules.length; i < len; ++i) {\n      const module = this._defaultModules[i];\n      const name = module.name;\n      modules[count++] = module;\n      seen[name] = true;\n    }\n    for (let i = 0, len = appModules.length; i < len; ++i) {\n      const module = appModules[i];\n      const name = module.name;\n      if (!seen[name]) {\n        modules[count++] = module;\n        seen[name] = true;\n      }\n    }\n    modules.length = count;\n    return modules;\n  }\n}","map":{"version":3,"sources":["../../../src/lib/program-manager.js"],"names":["assembleShaders","Program","ProgramManager","getDefaultProgramManager","gl","luma","defaultProgramManager","constructor","_programCache","_getUniforms","_registeredModules","_hookFunctions","_defaultModules","_hashes","_hashCounter","stateHash","_useCounts","addDefaultModule","module","find","m","name","push","removeDefaultModule","moduleName","filter","addShaderHook","hook","opts","assign","get","props","vs","fs","defines","inject","varyings","bufferMode","transpileToGLSL100","modules","_getModuleList","vsHash","_getHash","fsHash","moduleHashes","map","sort","varyingHashes","v","defineKeys","Object","keys","injectKeys","defineHashes","injectHashes","key","hash","join","assembled","hookFunctions","getUniforms","x","program","release","delete","undefined","appModules","Array","length","seen","count","i","len"],"mappings":"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","sourcesContent":["import {assembleShaders} from '@luma.gl/shadertools';\nimport {Program} from '@luma.gl/webgl';\n\nexport default class ProgramManager {\n  static getDefaultProgramManager(gl) {\n    gl.luma = gl.luma || {};\n    gl.luma.defaultProgramManager = gl.luma.defaultProgramManager || new ProgramManager(gl);\n\n    return gl.luma.defaultProgramManager;\n  }\n\n  constructor(gl) {\n    this.gl = gl;\n\n    this._programCache = {};\n    this._getUniforms = {};\n    this._registeredModules = {}; // TODO: Remove? This isn't used anywhere in luma.gl\n    this._hookFunctions = [];\n    this._defaultModules = [];\n\n    this._hashes = {};\n    this._hashCounter = 0;\n    this.stateHash = 0; // Used change hashing if hooks are modified\n    this._useCounts = {};\n  }\n\n  addDefaultModule(module) {\n    if (!this._defaultModules.find(m => m.name === module.name)) {\n      this._defaultModules.push(module);\n    }\n\n    this.stateHash++;\n  }\n\n  removeDefaultModule(module) {\n    const moduleName = typeof module === 'string' ? module : module.name;\n    this._defaultModules = this._defaultModules.filter(m => m.name !== moduleName);\n    this.stateHash++;\n  }\n\n  addShaderHook(hook, opts) {\n    if (opts) {\n      hook = Object.assign(opts, {hook});\n    }\n\n    this._hookFunctions.push(hook);\n\n    this.stateHash++;\n  }\n\n  get(props = {}) {\n    const {\n      vs = '',\n      fs = '',\n      defines = {},\n      inject = {},\n      varyings = [],\n      bufferMode = 0x8c8d,\n      transpileToGLSL100 = false\n    } = props; // varyings/bufferMode for xform feedback, 0x8c8d = SEPARATE_ATTRIBS\n\n    const modules = this._getModuleList(props.modules); // Combine with default modules\n\n    const vsHash = this._getHash(vs);\n    const fsHash = this._getHash(fs);\n    const moduleHashes = modules.map(m => this._getHash(m.name)).sort();\n    const varyingHashes = varyings.map(v => this._getHash(v));\n\n    const defineKeys = Object.keys(defines).sort();\n    const injectKeys = Object.keys(inject).sort();\n    const defineHashes = [];\n    const injectHashes = [];\n\n    for (const key of defineKeys) {\n      defineHashes.push(this._getHash(key));\n      defineHashes.push(this._getHash(defines[key]));\n    }\n\n    for (const key of injectKeys) {\n      injectHashes.push(this._getHash(key));\n      injectHashes.push(this._getHash(inject[key]));\n    }\n\n    const hash = `${vsHash}/${fsHash}D${defineHashes.join('/')}M${moduleHashes.join(\n      '/'\n    )}I${injectHashes.join('/')}V${varyingHashes.join('/')}H${this.stateHash}B${bufferMode}${\n      transpileToGLSL100 ? 'T' : ''\n    }`;\n\n    if (!this._programCache[hash]) {\n      const assembled = assembleShaders(this.gl, {\n        vs,\n        fs,\n        modules,\n        inject,\n        defines,\n        hookFunctions: this._hookFunctions,\n        transpileToGLSL100\n      });\n\n      this._programCache[hash] = new Program(this.gl, {\n        hash,\n        vs: assembled.vs,\n        fs: assembled.fs,\n        varyings,\n        bufferMode\n      });\n\n      this._getUniforms[hash] = assembled.getUniforms || (x => {});\n      this._useCounts[hash] = 0;\n    }\n\n    this._useCounts[hash]++;\n\n    return this._programCache[hash];\n  }\n\n  getUniforms(program) {\n    return this._getUniforms[program.hash] || null;\n  }\n\n  release(program) {\n    const hash = program.hash;\n    this._useCounts[hash]--;\n\n    if (this._useCounts[hash] === 0) {\n      this._programCache[hash].delete();\n      delete this._programCache[hash];\n      delete this._getUniforms[hash];\n      delete this._useCounts[hash];\n    }\n  }\n\n  _getHash(key) {\n    if (this._hashes[key] === undefined) {\n      this._hashes[key] = this._hashCounter++;\n    }\n\n    return this._hashes[key];\n  }\n\n  // Dedup and combine with default modules\n  _getModuleList(appModules = []) {\n    const modules = new Array(this._defaultModules.length + appModules.length);\n    const seen = {};\n    let count = 0;\n\n    for (let i = 0, len = this._defaultModules.length; i < len; ++i) {\n      const module = this._defaultModules[i];\n      const name = module.name;\n      modules[count++] = module;\n      seen[name] = true;\n    }\n\n    for (let i = 0, len = appModules.length; i < len; ++i) {\n      const module = appModules[i];\n      const name = module.name;\n      if (!seen[name]) {\n        modules[count++] = module;\n        seen[name] = true;\n      }\n    }\n\n    modules.length = count;\n\n    return modules;\n  }\n}\n"]},"metadata":{},"sourceType":"module"}