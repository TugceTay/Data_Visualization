{"ast":null,"code":"import { isWebGL2, assertWebGL2Context, log } from '@luma.gl/gltools';\nimport Resource from './resource';\nimport Buffer from './buffer';\nimport { isObjectEmpty } from '../utils/utils';\nexport default class TransformFeedback extends Resource {\n  get [Symbol.toStringTag]() {\n    return 'TransformFeedback';\n  }\n  static isSupported(gl) {\n    return isWebGL2(gl);\n  }\n  constructor(gl) {\n    let props = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n    assertWebGL2Context(gl);\n    super(gl, props);\n    this.initialize(props);\n    this.stubRemovedMethods('TransformFeedback', 'v6.0', ['pause', 'resume']);\n    Object.seal(this);\n  }\n  initialize() {\n    let props = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n    this.buffers = {};\n    this.unused = {};\n    this.configuration = null;\n    this.bindOnUse = true;\n    if (!isObjectEmpty(this.buffers)) {\n      this.bind(() => this._unbindBuffers());\n    }\n    this.setProps(props);\n    return this;\n  }\n  setProps(props) {\n    if ('program' in props) {\n      this.configuration = props.program && props.program.configuration;\n    }\n    if ('configuration' in props) {\n      this.configuration = props.configuration;\n    }\n    if ('bindOnUse' in props) {\n      props = props.bindOnUse;\n    }\n    if ('buffers' in props) {\n      this.setBuffers(props.buffers);\n    }\n  }\n  setBuffers() {\n    let buffers = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n    this.bind(() => {\n      for (const bufferName in buffers) {\n        this.setBuffer(bufferName, buffers[bufferName]);\n      }\n    });\n    return this;\n  }\n  setBuffer(locationOrName, bufferOrParams) {\n    const location = this._getVaryingIndex(locationOrName);\n    const {\n      buffer,\n      byteSize,\n      byteOffset\n    } = this._getBufferParams(bufferOrParams);\n    if (location < 0) {\n      this.unused[locationOrName] = buffer;\n      log.warn(\"\".concat(this.id, \" unused varying buffer \").concat(locationOrName))();\n      return this;\n    }\n    this.buffers[location] = bufferOrParams;\n    if (!this.bindOnUse) {\n      this._bindBuffer(location, buffer, byteOffset, byteSize);\n    }\n    return this;\n  }\n  begin() {\n    let primitiveMode = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 0;\n    this.gl.bindTransformFeedback(36386, this.handle);\n    this._bindBuffers();\n    this.gl.beginTransformFeedback(primitiveMode);\n    return this;\n  }\n  end() {\n    this.gl.endTransformFeedback();\n    this._unbindBuffers();\n    this.gl.bindTransformFeedback(36386, null);\n    return this;\n  }\n  _getBufferParams(bufferOrParams) {\n    let byteOffset;\n    let byteSize;\n    let buffer;\n    if (bufferOrParams instanceof Buffer === false) {\n      buffer = bufferOrParams.buffer;\n      byteSize = bufferOrParams.byteSize;\n      byteOffset = bufferOrParams.byteOffset;\n    } else {\n      buffer = bufferOrParams;\n    }\n    if (byteOffset !== undefined || byteSize !== undefined) {\n      byteOffset = byteOffset || 0;\n      byteSize = byteSize || buffer.byteLength - byteOffset;\n    }\n    return {\n      buffer,\n      byteOffset,\n      byteSize\n    };\n  }\n  _getVaryingInfo(locationOrName) {\n    return this.configuration && this.configuration.getVaryingInfo(locationOrName);\n  }\n  _getVaryingIndex(locationOrName) {\n    if (this.configuration) {\n      return this.configuration.getVaryingInfo(locationOrName).location;\n    }\n    const location = Number(locationOrName);\n    return Number.isFinite(location) ? location : -1;\n  }\n  _bindBuffers() {\n    if (this.bindOnUse) {\n      for (const bufferIndex in this.buffers) {\n        const {\n          buffer,\n          byteSize,\n          byteOffset\n        } = this._getBufferParams(this.buffers[bufferIndex]);\n        this._bindBuffer(bufferIndex, buffer, byteOffset, byteSize);\n      }\n    }\n  }\n  _unbindBuffers() {\n    if (this.bindOnUse) {\n      for (const bufferIndex in this.buffers) {\n        this._bindBuffer(bufferIndex, null);\n      }\n    }\n  }\n  _bindBuffer(index, buffer) {\n    let byteOffset = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 0;\n    let byteSize = arguments.length > 3 ? arguments[3] : undefined;\n    const handle = buffer && buffer.handle;\n    if (!handle || byteSize === undefined) {\n      this.gl.bindBufferBase(35982, index, handle);\n    } else {\n      this.gl.bindBufferRange(35982, index, handle, byteOffset, byteSize);\n    }\n    return this;\n  }\n  _createHandle() {\n    return this.gl.createTransformFeedback();\n  }\n  _deleteHandle() {\n    this.gl.deleteTransformFeedback(this.handle);\n  }\n  _bindHandle(handle) {\n    this.gl.bindTransformFeedback(36386, this.handle);\n  }\n}","map":{"version":3,"sources":["../../../src/classes/transform-feedback.js"],"names":["isWebGL2","assertWebGL2Context","log","Resource","Buffer","isObjectEmpty","TransformFeedback","Symbol","toStringTag","isSupported","gl","constructor","props","initialize","stubRemovedMethods","Object","seal","buffers","unused","configuration","bindOnUse","bind","_unbindBuffers","setProps","program","setBuffers","bufferName","setBuffer","locationOrName","bufferOrParams","location","_getVaryingIndex","buffer","byteSize","byteOffset","_getBufferParams","warn","id","_bindBuffer","begin","primitiveMode","bindTransformFeedback","handle","_bindBuffers","beginTransformFeedback","end","endTransformFeedback","undefined","byteLength","_getVaryingInfo","getVaryingInfo","Number","isFinite","bufferIndex","index","bindBufferBase","bindBufferRange","_createHandle","createTransformFeedback","_deleteHandle","deleteTransformFeedback","_bindHandle"],"mappings":"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","sourcesContent":["import GL from '@luma.gl/constants';\nimport {isWebGL2, assertWebGL2Context, log} from '@luma.gl/gltools';\nimport Resource from './resource';\nimport Buffer from './buffer';\nimport {isObjectEmpty} from '../utils/utils';\n\n// NOTE: The `bindOnUse` flag is a major workaround:\n// See https://github.com/KhronosGroup/WebGL/issues/2346\n\nexport default class TransformFeedback extends Resource {\n  // eslint-disable-next-line accessor-pairs\n  get [Symbol.toStringTag]() {\n    return 'TransformFeedback';\n  }\n  static isSupported(gl) {\n    return isWebGL2(gl);\n  }\n\n  constructor(gl, props = {}) {\n    assertWebGL2Context(gl);\n    super(gl, props);\n\n    this.initialize(props);\n    this.stubRemovedMethods('TransformFeedback', 'v6.0', ['pause', 'resume']);\n    Object.seal(this);\n  }\n\n  initialize(props = {}) {\n    this.buffers = {};\n    this.unused = {};\n    this.configuration = null;\n    this.bindOnUse = true;\n\n    // Unbind any currently bound buffers\n    if (!isObjectEmpty(this.buffers)) {\n      this.bind(() => this._unbindBuffers());\n    }\n\n    this.setProps(props);\n    return this;\n  }\n\n  setProps(props) {\n    if ('program' in props) {\n      this.configuration = props.program && props.program.configuration;\n    }\n    if ('configuration' in props) {\n      this.configuration = props.configuration;\n    }\n    if ('bindOnUse' in props) {\n      props = props.bindOnUse;\n    }\n    if ('buffers' in props) {\n      this.setBuffers(props.buffers);\n    }\n  }\n\n  setBuffers(buffers = {}) {\n    this.bind(() => {\n      for (const bufferName in buffers) {\n        this.setBuffer(bufferName, buffers[bufferName]);\n      }\n    });\n    return this;\n  }\n\n  setBuffer(locationOrName, bufferOrParams) {\n    const location = this._getVaryingIndex(locationOrName);\n    const {buffer, byteSize, byteOffset} = this._getBufferParams(bufferOrParams);\n\n    if (location < 0) {\n      this.unused[locationOrName] = buffer;\n      log.warn(`${this.id} unused varying buffer ${locationOrName}`)();\n      return this;\n    }\n\n    this.buffers[location] = bufferOrParams;\n\n    // Need to avoid chrome bug where buffer that is already bound to a different target\n    // cannot be bound to 'TRANSFORM_FEEDBACK_BUFFER' target.\n    if (!this.bindOnUse) {\n      this._bindBuffer(location, buffer, byteOffset, byteSize);\n    }\n\n    return this;\n  }\n\n  begin(primitiveMode = GL.POINTS) {\n    // @ts-ignore\n    this.gl.bindTransformFeedback(GL.TRANSFORM_FEEDBACK, this.handle);\n    this._bindBuffers();\n    // @ts-ignore\n    this.gl.beginTransformFeedback(primitiveMode);\n    return this;\n  }\n\n  end() {\n    // @ts-ignore\n    this.gl.endTransformFeedback();\n    this._unbindBuffers();\n    // @ts-ignore\n    this.gl.bindTransformFeedback(GL.TRANSFORM_FEEDBACK, null);\n    return this;\n  }\n\n  // PRIVATE METHODS\n\n  _getBufferParams(bufferOrParams) {\n    let byteOffset;\n    let byteSize;\n    let buffer;\n    if (bufferOrParams instanceof Buffer === false) {\n      buffer = bufferOrParams.buffer;\n      byteSize = bufferOrParams.byteSize;\n      byteOffset = bufferOrParams.byteOffset;\n    } else {\n      buffer = bufferOrParams;\n    }\n    // to use bindBufferRange, either offset or size must be specified, use default value for the other.\n    if (byteOffset !== undefined || byteSize !== undefined) {\n      byteOffset = byteOffset || 0;\n      byteSize = byteSize || buffer.byteLength - byteOffset;\n    }\n    return {buffer, byteOffset, byteSize};\n  }\n\n  _getVaryingInfo(locationOrName) {\n    return this.configuration && this.configuration.getVaryingInfo(locationOrName);\n  }\n\n  _getVaryingIndex(locationOrName) {\n    if (this.configuration) {\n      return this.configuration.getVaryingInfo(locationOrName).location;\n    }\n    const location = Number(locationOrName);\n    return Number.isFinite(location) ? location : -1;\n  }\n\n  // Need to avoid chrome bug where buffer that is already bound to a different target\n  // cannot be bound to 'TRANSFORM_FEEDBACK_BUFFER' target.\n  _bindBuffers() {\n    if (this.bindOnUse) {\n      for (const bufferIndex in this.buffers) {\n        const {buffer, byteSize, byteOffset} = this._getBufferParams(this.buffers[bufferIndex]);\n        this._bindBuffer(bufferIndex, buffer, byteOffset, byteSize);\n      }\n    }\n  }\n\n  _unbindBuffers() {\n    if (this.bindOnUse) {\n      for (const bufferIndex in this.buffers) {\n        this._bindBuffer(bufferIndex, null);\n      }\n    }\n  }\n\n  _bindBuffer(index, buffer, byteOffset = 0, byteSize) {\n    const handle = buffer && buffer.handle;\n    if (!handle || byteSize === undefined) {\n      // @ts-ignore\n      this.gl.bindBufferBase(GL.TRANSFORM_FEEDBACK_BUFFER, index, handle);\n    } else {\n      // @ts-ignore\n      this.gl.bindBufferRange(GL.TRANSFORM_FEEDBACK_BUFFER, index, handle, byteOffset, byteSize);\n    }\n    return this;\n  }\n\n  // RESOURCE METHODS\n\n  _createHandle() {\n    // @ts-ignore\n    return this.gl.createTransformFeedback();\n  }\n\n  _deleteHandle() {\n    // @ts-ignore\n    this.gl.deleteTransformFeedback(this.handle);\n  }\n\n  _bindHandle(handle) {\n    // @ts-ignore\n    this.gl.bindTransformFeedback(GL.TRANSFORM_FEEDBACK, this.handle);\n  }\n}\n"]},"metadata":{},"sourceType":"module"}