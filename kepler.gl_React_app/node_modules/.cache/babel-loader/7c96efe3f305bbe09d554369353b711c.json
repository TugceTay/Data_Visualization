{"ast":null,"code":"import _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"@babel/runtime/helpers/esm/asyncToGenerator\";\nimport _classCallCheck from \"@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"@babel/runtime/helpers/esm/createClass\";\nimport { getWorkerURL } from './get-worker-url';\nimport { getTransferList } from './get-transfer-list';\nvar count = 0;\nfunction defaultOnMessage(_ref) {\n  var data = _ref.data,\n    resolve = _ref.resolve;\n  resolve(data);\n}\nvar WorkerThread = function () {\n  function WorkerThread(_ref2) {\n    var source = _ref2.source,\n      _ref2$name = _ref2.name,\n      name = _ref2$name === void 0 ? \"web-worker-\".concat(count++) : _ref2$name,\n      onMessage = _ref2.onMessage;\n    _classCallCheck(this, WorkerThread);\n    var url = getWorkerURL(source, name);\n    this.worker = new Worker(url, {\n      name: name\n    });\n    this.name = name;\n    this.onMessage = onMessage || defaultOnMessage;\n  }\n  _createClass(WorkerThread, [{\n    key: \"process\",\n    value: function () {\n      var _process = _asyncToGenerator(_regeneratorRuntime.mark(function _callee(data) {\n        var _this = this;\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                return _context.abrupt(\"return\", new Promise(function (resolve, reject) {\n                  _this.worker.onmessage = function (event) {\n                    _this.onMessage({\n                      worker: _this.worker,\n                      data: event.data,\n                      resolve: resolve,\n                      reject: reject\n                    });\n                  };\n                  _this.worker.onerror = function (error) {\n                    var message = \"\".concat(_this.name, \": WorkerThread.process() failed\");\n                    if (error.message) {\n                      message += \" \".concat(error.message, \" \").concat(error.filename, \":\").concat(error.lineno, \":\").concat(error.colno);\n                    }\n                    var betterError = new Error(message);\n                    console.error(error);\n                    reject(betterError);\n                  };\n                  var transferList = getTransferList(data);\n                  _this.worker.postMessage(data, transferList);\n                }));\n              case 1:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee);\n      }));\n      function process(_x) {\n        return _process.apply(this, arguments);\n      }\n      return process;\n    }()\n  }, {\n    key: \"destroy\",\n    value: function destroy() {\n      this.worker.terminate();\n      this.worker = null;\n    }\n  }]);\n  return WorkerThread;\n}();\nexport { WorkerThread as default };","map":{"version":3,"sources":["../../../../src/lib/worker-utils/worker-thread.js"],"names":["getWorkerURL","getTransferList","count","defaultOnMessage","data","resolve","WorkerThread","source","name","onMessage","url","worker","Worker","Promise","reject","onmessage","event","onerror","message","error","filename","lineno","colno","betterError","Error","console","transferList","postMessage","terminate"],"mappings":";;;;AACA,SAAQA,YAAR,QAA2B,kBAA3B;AACA,SAAQC,eAAR,QAA8B,qBAA9B;AAEA,IAAIC,KAAK,GAAG,CAAZ;AAGA,SAASC,gBAAT,CAAA,IAAA,EAA2C;EAAA,IAAhBC,IAAgB,GAAA,IAAA,CAAhBA,IAAgB;IAAVC,OAAU,GAAA,IAAA,CAAVA,OAAU;EACzCA,OAAO,CAACD,IAAD,CAAPC;AACD;IAEoBC,Y;EACnB,SAAA,YAAA,CAAA,KAAA,EAAiE;IAAA,IAApDC,MAAoD,GAAA,KAAA,CAApDA,MAAoD;MAAA,UAAA,GAAA,KAAA,CAA5CC,IAA4C;MAA5CA,IAA4C,GAAA,UAAA,KAAA,KAAA,CAAA,GAAA,aAAA,CAAA,MAAA,CAAvBN,KAAK,EAAkB,CAAA,GAAA,UAAA;MAAZO,SAAY,GAAA,KAAA,CAAZA,SAAY;IAAA,eAAA,CAAA,IAAA,EAAA,YAAA,CAAA;IAC/D,IAAMC,GAAG,GAAGV,YAAY,CAACO,MAAD,EAASC,IAAT,CAAxB;IACA,IAAA,CAAKG,MAAL,GAAc,IAAIC,MAAJ,CAAWF,GAAX,EAAgB;MAACF,IAAI,EAAJA;IAAD,CAAhB,CAAd;IACA,IAAA,CAAKA,IAAL,GAAYA,IAAZ;IACA,IAAA,CAAKC,SAAL,GAAiBA,SAAS,IAAIN,gBAA9B;EACD;;;;iFAKaC,I;;;;;;iDACL,IAAIS,OAAJ,CAAY,UAACR,OAAD,EAAUS,MAAV,EAAqB;kBACtC,KAAI,CAACH,MAAL,CAAYI,SAAZ,GAAwB,UAAA,KAAK,EAAI;oBAC/B,KAAI,CAACN,SAAL,CAAe;sBAACE,MAAM,EAAE,KAAI,CAACA,MAAd;sBAAsBP,IAAI,EAAEY,KAAK,CAACZ,IAAlC;sBAAwCC,OAAO,EAAPA,OAAxC;sBAAiDS,MAAM,EAANA;oBAAjD,CAAf,CAAA;kBACD,CAFD;kBAGA,KAAI,CAACH,MAAL,CAAYM,OAAZ,GAAsB,UAAA,KAAK,EAAI;oBAI7B,IAAIC,OAAO,GAAA,EAAA,CAAA,MAAA,CAAM,KAAI,CAACV,IAAX,EAAA,iCAAA,CAAX;oBACA,IAAIW,KAAK,CAACD,OAAV,EAAmB;sBACjBA,OAAO,IAAA,GAAA,CAAA,MAAA,CAAQC,KAAK,CAACD,OAAd,EAAA,GAAA,CAAA,CAAA,MAAA,CAAyBC,KAAK,CAACC,QAA/B,EAAA,GAAA,CAAA,CAAA,MAAA,CAA2CD,KAAK,CAACE,MAAjD,EAAA,GAAA,CAAA,CAAA,MAAA,CAA2DF,KAAK,CAACG,KAAjE,CAAPJ;oBACD;oBACD,IAAMK,WAAW,GAAG,IAAIC,KAAJ,CAAUN,OAAV,CAApB;oBACAO,OAAO,CAACN,KAARM,CAAcN,KAAdM,CAAAA;oBACAX,MAAM,CAACS,WAAD,CAANT;kBACD,CAXD;kBAYA,IAAMY,YAAY,GAAGzB,eAAe,CAACG,IAAD,CAApC;kBACA,KAAI,CAACO,MAAL,CAAYgB,WAAZ,CAAwBvB,IAAxB,EAA8BsB,YAA9B,CAAA;gBACD,CAlBM,C;;;;;;;;;;;;;;;8BAqBC;MACR,IAAA,CAAKf,MAAL,CAAYiB,SAAZ,EAAA;MAEA,IAAA,CAAKjB,MAAL,GAAc,IAAd;IACD;;;;SArCkBL,Y","sourcesContent":["/* global Worker */\nimport {getWorkerURL} from './get-worker-url';\nimport {getTransferList} from './get-transfer-list';\n\nlet count = 0;\n\n// By default resolves to the first message the worker sends back\nfunction defaultOnMessage({data, resolve}) {\n  resolve(data);\n}\n\nexport default class WorkerThread {\n  constructor({source, name = `web-worker-${count++}`, onMessage}) {\n    const url = getWorkerURL(source, name);\n    this.worker = new Worker(url, {name});\n    this.name = name;\n    this.onMessage = onMessage || defaultOnMessage;\n  }\n\n  /**\n   * Process binary data in a worker\n   */\n  async process(data) {\n    return new Promise((resolve, reject) => {\n      this.worker.onmessage = event => {\n        this.onMessage({worker: this.worker, data: event.data, resolve, reject});\n      };\n      this.worker.onerror = error => {\n        // Note Error object does not have the expected fields if loading failed completely\n        // https://developer.mozilla.org/en-US/docs/Web/API/Worker#Event_handlers\n        // https://developer.mozilla.org/en-US/docs/Web/API/ErrorEvent\n        let message = `${this.name}: WorkerThread.process() failed`;\n        if (error.message) {\n          message += ` ${error.message} ${error.filename}:${error.lineno}:${error.colno}`;\n        }\n        const betterError = new Error(message);\n        console.error(error); // eslint-disable-line\n        reject(betterError);\n      };\n      const transferList = getTransferList(data);\n      this.worker.postMessage(data, transferList);\n    });\n  }\n\n  destroy() {\n    this.worker.terminate();\n    // @ts-ignore\n    this.worker = null;\n  }\n}\n"]},"metadata":{},"sourceType":"module"}