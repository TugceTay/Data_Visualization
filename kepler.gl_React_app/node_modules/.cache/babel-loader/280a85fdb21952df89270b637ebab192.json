{"ast":null,"code":"import { log } from '@luma.gl/webgl';\nimport Display from './display';\nimport { createEnterVRButton } from './vr-button';\nexport default class VRDisplay extends Display {\n  static isSupported() {\n    return typeof navigator !== 'undefined' && 'getVRDisplays' in navigator && 'VRFrameData' in window;\n  }\n  constructor(props) {\n    super(props);\n    this._vrSupported = VRDisplay.isSupported();\n    if (this._vrSupported) {\n      this.vrFrameData = new window.VRFrameData();\n      this.vrPresenting = false;\n      this.vrFrame = false;\n      window.addEventListener('vrdisplaypresentchange', this._vrDisplayPresentChange.bind(this));\n    }\n  }\n  delete() {\n    super.delete();\n    this._removeVRButton();\n  }\n  getViews(options) {\n    if (this._vrSupported) {\n      this._addVRButton();\n    }\n    if (this.vrPresenting && this.vrFrame) {\n      this.vrDisplay.getFrameData(this.vrFrameData);\n      const {\n        leftProjectionMatrix,\n        leftViewMatrix,\n        rightProjectionMatrix,\n        rightViewMatrix\n      } = this.vrFrameData;\n      const {\n        width,\n        height\n      } = options;\n      return [{\n        displayEye: 'left',\n        projectionMatrix: leftProjectionMatrix,\n        viewMatrix: leftViewMatrix,\n        params: {\n          viewport: [0, 0, width * 0.5, height],\n          scissor: [0, 0, width * 0.5, height],\n          scissorTest: true\n        }\n      }, {\n        displayEye: 'right',\n        projectionMatrix: rightProjectionMatrix,\n        viewMatrix: rightViewMatrix,\n        params: {\n          viewport: [width * 0.5, 0, width * 0.5, height],\n          scissor: [width * 0.5, 0, width * 0.5, height],\n          scissorTest: true\n        }\n      }];\n    }\n    return super.getViews(options);\n  }\n  submitFrame() {\n    if (this.vrPresenting && this.vrFrame) {\n      this.vrDisplay.submitFrame();\n      return true;\n    }\n    return false;\n  }\n  requestAnimationFrame(renderFrame) {\n    if (this.vrPresenting) {\n      this.vrDisplay.requestAnimationFrame(() => {\n        this.vrFrame = true;\n        renderFrame();\n        this.vrFrame = false;\n      });\n      return true;\n    }\n    return false;\n  }\n  async _addVRButton() {\n    if (this.vrButton) {\n      return;\n    }\n    const canvas = this._getCanvas();\n    if (!canvas) {\n      return;\n    }\n    const displays = await navigator.getVRDisplays();\n    if (displays && displays.length) {\n      log.info(2, 'Found VR Displays', displays)();\n      this.vrDisplay = displays[0];\n      this.vrButton = createEnterVRButton({\n        canvas,\n        title: \"Enter VR (\".concat(this.vrDisplay.displayName, \")\")\n      });\n      this.vrButton.onclick = () => this._startDisplay();\n    }\n  }\n  _getCanvas() {\n    return this.animationLoop.canvas || this.animationLoop.gl && this.animationLoop.gl.canvas;\n  }\n  _removeVRButton() {\n    if (this.vrButton) {}\n  }\n  _startDisplay() {\n    this.vrDisplay.requestPresent([{\n      source: this._getCanvas()\n    }]);\n  }\n  _vrDisplayPresentChange() {\n    if (this.vrDisplay.isPresenting) {\n      log.info(2, 'Entering VR')();\n      this.vrPresenting = true;\n      this.vrButton.style.display = 'none';\n    } else {\n      log.info(2, 'Exiting VR')();\n      this.vrPresenting = false;\n      this.vrButton.style.display = 'block';\n    }\n  }\n}","map":{"version":3,"sources":["../../../src/webvr/vr-display.js"],"names":["log","Display","createEnterVRButton","VRDisplay","isSupported","navigator","window","constructor","props","_vrSupported","vrFrameData","VRFrameData","vrPresenting","vrFrame","addEventListener","_vrDisplayPresentChange","bind","delete","_removeVRButton","getViews","options","_addVRButton","vrDisplay","getFrameData","leftProjectionMatrix","leftViewMatrix","rightProjectionMatrix","rightViewMatrix","width","height","displayEye","projectionMatrix","viewMatrix","params","viewport","scissor","scissorTest","submitFrame","requestAnimationFrame","renderFrame","vrButton","canvas","_getCanvas","displays","getVRDisplays","length","info","title","displayName","onclick","_startDisplay","animationLoop","gl","requestPresent","source","isPresenting","style","display"],"mappings":"AAAA,SAAQA,GAAR,QAAkB,gBAAlB;AACA,OAAOC,OAAP,MAAoB,WAApB;AACA,SAAQC,mBAAR,QAAkC,aAAlC;AAEA,eAAe,MAAMC,SAAN,SAAwBF,OAAxB,CAAgC;EAC3B,OAAXG,WAAW,GAAG;IACnB,OACE,OAAOC,SAAP,KAAqB,WAArB,IAAoC,eAAA,IAAmBA,SAAvD,IAAoE,aAAA,IAAiBC,MADvF;EAGD;EAEDC,WAAW,CAACC,KAAD,EAAQ;IACjB,KAAA,CAAMA,KAAN,CAAA;IAEA,IAAA,CAAKC,YAAL,GAAoBN,SAAS,CAACC,WAAVD,EAApB;IACA,IAAI,IAAA,CAAKM,YAAT,EAAuB;MAErB,IAAA,CAAKC,WAAL,GAAmB,IAAIJ,MAAM,CAACK,WAAX,EAAnB;MACA,IAAA,CAAKC,YAAL,GAAoB,KAApB;MACA,IAAA,CAAKC,OAAL,GAAe,KAAf;MACAP,MAAM,CAACQ,gBAAPR,CAAwB,wBAAxBA,EAAkD,IAAA,CAAKS,uBAAL,CAA6BC,IAA7B,CAAkC,IAAlC,CAAlDV,CAAAA;IACD;EACF;EAEDW,MAAM,GAAG;IACP,KAAA,CAAMA,MAAN,EAAA;IACA,IAAA,CAAKC,eAAL,EAAA;EACD;EAEDC,QAAQ,CAACC,OAAD,EAAU;IAChB,IAAI,IAAA,CAAKX,YAAT,EAAuB;MACrB,IAAA,CAAKY,YAAL,EAAA;IACD;IAKD,IAAI,IAAA,CAAKT,YAAL,IAAqB,IAAA,CAAKC,OAA9B,EAAuC;MACrC,IAAA,CAAKS,SAAL,CAAeC,YAAf,CAA4B,IAAA,CAAKb,WAAjC,CAAA;MAEA,MAAM;QACJc,oBADI;QAEJC,cAFI;QAGJC,qBAHI;QAIJC;MAJI,CAAA,GAKF,IAAA,CAAKjB,WALT;MAOA,MAAM;QAACkB,KAAD;QAAQC;MAAR,CAAA,GAAkBT,OAAxB;MAEA,OAAO,CACL;QACEU,UAAU,EAAE,MADd;QAEEC,gBAAgB,EAAEP,oBAFpB;QAGEQ,UAAU,EAAEP,cAHd;QAIEQ,MAAM,EAAE;UACNC,QAAQ,EAAE,CAAC,CAAD,EAAI,CAAJ,EAAON,KAAK,GAAG,GAAf,EAAoBC,MAApB,CADJ;UAENM,OAAO,EAAE,CAAC,CAAD,EAAI,CAAJ,EAAOP,KAAK,GAAG,GAAf,EAAoBC,MAApB,CAFH;UAGNO,WAAW,EAAE;QAHP;MAJV,CADK,EAWL;QACEN,UAAU,EAAE,OADd;QAEEC,gBAAgB,EAAEL,qBAFpB;QAGEM,UAAU,EAAEL,eAHd;QAIEM,MAAM,EAAE;UACNC,QAAQ,EAAE,CAACN,KAAK,GAAG,GAAT,EAAc,CAAd,EAAiBA,KAAK,GAAG,GAAzB,EAA8BC,MAA9B,CADJ;UAENM,OAAO,EAAE,CAACP,KAAK,GAAG,GAAT,EAAc,CAAd,EAAiBA,KAAK,GAAG,GAAzB,EAA8BC,MAA9B,CAFH;UAGNO,WAAW,EAAE;QAHP;MAJV,CAXK,CAAP;IAsBD;IAED,OAAO,KAAA,CAAMjB,QAAN,CAAeC,OAAf,CAAP;EACD;EAEDiB,WAAW,GAAG;IACZ,IAAI,IAAA,CAAKzB,YAAL,IAAqB,IAAA,CAAKC,OAA9B,EAAuC;MACrC,IAAA,CAAKS,SAAL,CAAee,WAAf,EAAA;MACA,OAAO,IAAP;IACD;IAED,OAAO,KAAP;EACD;EAEDC,qBAAqB,CAACC,WAAD,EAAc;IACjC,IAAI,IAAA,CAAK3B,YAAT,EAAuB;MACrB,IAAA,CAAKU,SAAL,CAAegB,qBAAf,CAAqC,MAAM;QACzC,IAAA,CAAKzB,OAAL,GAAe,IAAf;QACA0B,WAAW,EAAA;QACX,IAAA,CAAK1B,OAAL,GAAe,KAAf;MACD,CAJD,CAAA;MAMA,OAAO,IAAP;IACD;IAED,OAAO,KAAP;EACD;EAMiB,MAAZQ,YAAY,GAAG;IACnB,IAAI,IAAA,CAAKmB,QAAT,EAAmB;MACjB;IACD;IAED,MAAMC,MAAM,GAAG,IAAA,CAAKC,UAAL,EAAf;IACA,IAAI,CAACD,MAAL,EAAa;MACX;IACD;IAGD,MAAME,QAAQ,GAAG,MAAMtC,SAAS,CAACuC,aAAVvC,EAAvB;IACA,IAAIsC,QAAQ,IAAIA,QAAQ,CAACE,MAAzB,EAAiC;MAC/B7C,GAAG,CAAC8C,IAAJ9C,CAAS,CAATA,EAAY,mBAAZA,EAAiC2C,QAAjC3C,CAAAA,EAAAA;MAEA,IAAA,CAAKsB,SAAL,GAAiBqB,QAAQ,CAAC,CAAD,CAAzB;MACA,IAAA,CAAKH,QAAL,GAAgBtC,mBAAmB,CAAC;QAClCuC,MADkC;QAElCM,KAAK,EAAA,YAAA,CAAA,MAAA,CAAe,IAAA,CAAKzB,SAAL,CAAe0B,WAA9B,EAAA,GAAA;MAF6B,CAAD,CAAnC;MAIA,IAAA,CAAKR,QAAL,CAAcS,OAAd,GAAwB,MAAM,IAAA,CAAKC,aAAL,EAA9B;IACD;EACF;EAEDR,UAAU,GAAG;IACX,OAAO,IAAA,CAAKS,aAAL,CAAmBV,MAAnB,IAA8B,IAAA,CAAKU,aAAL,CAAmBC,EAAnB,IAAyB,IAAA,CAAKD,aAAL,CAAmBC,EAAnB,CAAsBX,MAApF;EACD;EAEDvB,eAAe,GAAG;IAChB,IAAI,IAAA,CAAKsB,QAAT,EAAmB,CAElB;EACF;EAEDU,aAAa,GAAG;IAEd,IAAA,CAAK5B,SAAL,CAAe+B,cAAf,CAA8B,CAC5B;MACEC,MAAM,EAAE,IAAA,CAAKZ,UAAL;IADV,CAD4B,CAA9B,CAAA;EAKD;EAED3B,uBAAuB,GAAG;IACxB,IAAI,IAAA,CAAKO,SAAL,CAAeiC,YAAnB,EAAiC;MAC/BvD,GAAG,CAAC8C,IAAJ9C,CAAS,CAATA,EAAY,aAAZA,CAAAA,EAAAA;MAEA,IAAA,CAAKY,YAAL,GAAoB,IAApB;MACA,IAAA,CAAK4B,QAAL,CAAcgB,KAAd,CAAoBC,OAApB,GAA8B,MAA9B;IACD,CALD,MAKO;MACLzD,GAAG,CAAC8C,IAAJ9C,CAAS,CAATA,EAAY,YAAZA,CAAAA,EAAAA;MAEA,IAAA,CAAKY,YAAL,GAAoB,KAApB;MACA,IAAA,CAAK4B,QAAL,CAAcgB,KAAd,CAAoBC,OAApB,GAA8B,OAA9B;IACD;EACF;AA1J4C","sourcesContent":["import {log} from '@luma.gl/webgl';\nimport Display from './display';\nimport {createEnterVRButton} from './vr-button';\n\nexport default class VRDisplay extends Display {\n  static isSupported() {\n    return (\n      typeof navigator !== 'undefined' && 'getVRDisplays' in navigator && 'VRFrameData' in window\n    );\n  }\n\n  constructor(props) {\n    super(props);\n\n    this._vrSupported = VRDisplay.isSupported();\n    if (this._vrSupported) {\n      // @ts-expect-error\n      this.vrFrameData = new window.VRFrameData();\n      this.vrPresenting = false;\n      this.vrFrame = false;\n      window.addEventListener('vrdisplaypresentchange', this._vrDisplayPresentChange.bind(this));\n    }\n  }\n\n  delete() {\n    super.delete();\n    this._removeVRButton();\n  }\n\n  getViews(options) {\n    if (this._vrSupported) {\n      this._addVRButton();\n    }\n\n    // Need both vrPresenting and vrFrame\n    // to avoid race conditions when we exit VR\n    // after we schedule an animation frame\n    if (this.vrPresenting && this.vrFrame) {\n      this.vrDisplay.getFrameData(this.vrFrameData);\n\n      const {\n        leftProjectionMatrix,\n        leftViewMatrix,\n        rightProjectionMatrix,\n        rightViewMatrix\n      } = this.vrFrameData;\n\n      const {width, height} = options;\n\n      return [\n        {\n          displayEye: 'left',\n          projectionMatrix: leftProjectionMatrix,\n          viewMatrix: leftViewMatrix,\n          params: {\n            viewport: [0, 0, width * 0.5, height],\n            scissor: [0, 0, width * 0.5, height],\n            scissorTest: true\n          }\n        },\n        {\n          displayEye: 'right',\n          projectionMatrix: rightProjectionMatrix,\n          viewMatrix: rightViewMatrix,\n          params: {\n            viewport: [width * 0.5, 0, width * 0.5, height],\n            scissor: [width * 0.5, 0, width * 0.5, height],\n            scissorTest: true\n          }\n        }\n      ];\n    }\n\n    return super.getViews(options);\n  }\n\n  submitFrame() {\n    if (this.vrPresenting && this.vrFrame) {\n      this.vrDisplay.submitFrame();\n      return true;\n    }\n\n    return false;\n  }\n\n  requestAnimationFrame(renderFrame) {\n    if (this.vrPresenting) {\n      this.vrDisplay.requestAnimationFrame(() => {\n        this.vrFrame = true;\n        renderFrame();\n        this.vrFrame = false;\n      });\n\n      return true;\n    }\n\n    return false;\n  }\n\n  // PRIVATE\n\n  // TODO: Consider resizing canvas to match vrDisplay.getEyeParameters()\n  // TODO: Maybe allow to select display?\n  async _addVRButton() {\n    if (this.vrButton) {\n      return;\n    }\n\n    const canvas = this._getCanvas();\n    if (!canvas) {\n      return;\n    }\n\n    // @ts-expect-error\n    const displays = await navigator.getVRDisplays();\n    if (displays && displays.length) {\n      log.info(2, 'Found VR Displays', displays)();\n\n      this.vrDisplay = displays[0];\n      this.vrButton = createEnterVRButton({\n        canvas,\n        title: `Enter VR (${this.vrDisplay.displayName})`\n      });\n      this.vrButton.onclick = () => this._startDisplay();\n    }\n  }\n\n  _getCanvas() {\n    return this.animationLoop.canvas || (this.animationLoop.gl && this.animationLoop.gl.canvas);\n  }\n\n  _removeVRButton() {\n    if (this.vrButton) {\n      // TODO\n    }\n  }\n\n  _startDisplay() {\n    // @ts-ignore\n    this.vrDisplay.requestPresent([\n      {\n        source: this._getCanvas()\n      }\n    ]);\n  }\n\n  _vrDisplayPresentChange() {\n    if (this.vrDisplay.isPresenting) {\n      log.info(2, 'Entering VR')();\n\n      this.vrPresenting = true;\n      this.vrButton.style.display = 'none';\n    } else {\n      log.info(2, 'Exiting VR')();\n\n      this.vrPresenting = false;\n      this.vrButton.style.display = 'block';\n    }\n  }\n}\n"]},"metadata":{},"sourceType":"module"}