{"ast":null,"code":"\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\nvar _interopRequireWildcard = require(\"@babel/runtime/helpers/interopRequireWildcard\");\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.FilterAnimationControllerFactory = FilterAnimationControllerFactory;\nexports.LayerAnimationControllerFactory = LayerAnimationControllerFactory;\nexports[\"default\"] = BottomWidgetFactory;\nvar _extends2 = _interopRequireDefault(require(\"@babel/runtime/helpers/extends\"));\nvar _taggedTemplateLiteral2 = _interopRequireDefault(require(\"@babel/runtime/helpers/taggedTemplateLiteral\"));\nvar _react = _interopRequireWildcard(require(\"react\"));\nvar _styledComponents = _interopRequireDefault(require(\"styled-components\"));\nvar _timeWidget = _interopRequireDefault(require(\"./filters/time-widget\"));\nvar _animationControl = _interopRequireDefault(require(\"./common/animation-control/animation-control\"));\nvar _animationController = _interopRequireDefault(require(\"./common/animation-control/animation-controller\"));\nvar _defaultSettings = require(\"../constants/default-settings\");\nvar _filterUtils = require(\"../utils/filter-utils\");\nvar _mediaBreakpoints = require(\"../styles/media-breakpoints\");\nvar _templateObject, _templateObject2;\nvar maxWidth = 1080;\nvar BottomWidgetContainer = _styledComponents[\"default\"].div(_templateObject || (_templateObject = (0, _taggedTemplateLiteral2[\"default\"])([\"\\n  display: flex;\\n  flex-direction: column;\\n  padding-top: \", \"px;\\n  padding-right: \", \"px;\\n  padding-bottom: \", \"px;\\n  padding-left: \", \"px;\\n  pointer-events: none !important; /* prevent padding from blocking input */\\n  & > * {\\n    /* all children should allow input */\\n    pointer-events: all;\\n  }\\n  width: \", \"px;\\n  z-index: 1;\\n  \", \"\\n\"])), function (props) {\n  return props.hasPadding ? props.theme.bottomWidgetPaddingTop : 0;\n}, function (props) {\n  return props.hasPadding ? props.theme.bottomWidgetPaddingRight : 0;\n}, function (props) {\n  return props.hasPadding ? props.theme.bottomWidgetPaddingBottom : 0;\n}, function (props) {\n  return props.hasPadding ? props.theme.bottomWidgetPaddingLeft : 0;\n}, function (props) {\n  return props.width;\n}, _mediaBreakpoints.media.portable(_templateObject2 || (_templateObject2 = (0, _taggedTemplateLiteral2[\"default\"])([\"padding: 0;\"]))));\nFilterAnimationControllerFactory.deps = [_animationController[\"default\"]];\nfunction FilterAnimationControllerFactory(AnimationController) {\n  var FilterAnimationController = function FilterAnimationController(_ref) {\n    var filter = _ref.filter,\n      filterIdx = _ref.filterIdx,\n      setFilterAnimationTime = _ref.setFilterAnimationTime,\n      children = _ref.children;\n    var intervalBins = (0, _react.useMemo)(function () {\n      return (0, _filterUtils.getIntervalBins)(filter);\n    }, [filter]);\n    var steps = (0, _react.useMemo)(function () {\n      return intervalBins ? intervalBins.map(function (x) {\n        return x.x0;\n      }) : null;\n    }, [intervalBins]);\n    var updateAnimation = (0, _react.useCallback)(function (value) {\n      switch (filter.animationWindow) {\n        case _defaultSettings.ANIMATION_WINDOW.interval:\n          var idx = value[1];\n          setFilterAnimationTime(filterIdx, 'value', [intervalBins[idx].x0, intervalBins[idx].x1 - 1]);\n          break;\n        default:\n          setFilterAnimationTime(filterIdx, 'value', value);\n          break;\n      }\n    }, [filterIdx, intervalBins, filter.animationWindow, setFilterAnimationTime]);\n    return /*#__PURE__*/_react[\"default\"].createElement(AnimationController, {\n      key: \"filter-control\",\n      value: filter.value,\n      domain: filter.domain,\n      speed: filter.speed,\n      isAnimating: filter.isAnimating,\n      animationWindow: filter.animationWindow,\n      steps: steps,\n      updateAnimation: updateAnimation,\n      children: children\n    });\n  };\n  return FilterAnimationController;\n}\nLayerAnimationControllerFactory.deps = [_animationController[\"default\"]];\nfunction LayerAnimationControllerFactory(AnimationController) {\n  var LayerAnimationController = function LayerAnimationController(_ref2) {\n    var animationConfig = _ref2.animationConfig,\n      setLayerAnimationTime = _ref2.setLayerAnimationTime,\n      children = _ref2.children;\n    return /*#__PURE__*/_react[\"default\"].createElement(AnimationController, {\n      key: \"layer-control\",\n      value: animationConfig.currentTime,\n      domain: animationConfig.domain,\n      speed: animationConfig.speed,\n      isAnimating: animationConfig.isAnimating,\n      updateAnimation: setLayerAnimationTime,\n      steps: animationConfig.timeSteps,\n      animationWindow: animationConfig.timeSteps ? _defaultSettings.ANIMATION_WINDOW.interval : _defaultSettings.ANIMATION_WINDOW.point,\n      children: children\n    });\n  };\n  return LayerAnimationController;\n}\nBottomWidgetFactory.deps = [_timeWidget[\"default\"], _animationControl[\"default\"], FilterAnimationControllerFactory, LayerAnimationControllerFactory];\n/* eslint-disable complexity */\n\nfunction BottomWidgetFactory(TimeWidget, AnimationControl, FilterAnimationController, LayerAnimationController) {\n  var BottomWidget = function BottomWidget(props) {\n    var datasets = props.datasets,\n      filters = props.filters,\n      animationConfig = props.animationConfig,\n      visStateActions = props.visStateActions,\n      containerW = props.containerW,\n      uiState = props.uiState,\n      sidePanelWidth = props.sidePanelWidth,\n      layers = props.layers;\n    var activeSidePanel = uiState.activeSidePanel,\n      readOnly = uiState.readOnly;\n    var isOpen = Boolean(activeSidePanel);\n    var enlargedFilterIdx = (0, _react.useMemo)(function () {\n      return filters.findIndex(function (f) {\n        return f.enlarged && f.type === _defaultSettings.FILTER_TYPES.timeRange;\n      });\n    }, [filters]);\n    var animatedFilterIdx = (0, _react.useMemo)(function () {\n      return filters.findIndex(function (f) {\n        return f.isAnimating;\n      });\n    }, [filters]);\n    var animatedFilter = animatedFilterIdx > -1 ? filters[animatedFilterIdx] : null;\n    var enlargedFilterWidth = isOpen ? containerW - sidePanelWidth : containerW; // show playback control if layers contain trip layer & at least one trip layer is visible\n\n    var animatableLayer = (0, _react.useMemo)(function () {\n      return layers.filter(function (l) {\n        return l.config.animation && l.config.animation.enabled && l.config.isVisible;\n      });\n    }, [layers]);\n    var readyToAnimation = Array.isArray(animationConfig.domain) && Number.isFinite(animationConfig.currentTime); // if animation control is showing, hide time display in time slider\n\n    var showFloatingTimeDisplay = !animatableLayer.length;\n    var showAnimationControl = animatableLayer.length && readyToAnimation && !animationConfig.hideControl;\n    var showTimeWidget = enlargedFilterIdx > -1 && Object.keys(datasets).length > 0; // if filter is not animating, pass in enlarged filter here because\n    // animation controller needs to call reset on it\n\n    var filter = animatedFilter || filters[enlargedFilterIdx];\n    return /*#__PURE__*/_react[\"default\"].createElement(BottomWidgetContainer, {\n      width: Math.min(maxWidth, enlargedFilterWidth),\n      className: \"bottom-widget--container\",\n      hasPadding: showAnimationControl || showTimeWidget\n    }, /*#__PURE__*/_react[\"default\"].createElement(LayerAnimationController, {\n      animationConfig: animationConfig,\n      setLayerAnimationTime: visStateActions.setLayerAnimationTime\n    }, function (isAnimating, start, pause, reset) {\n      return showAnimationControl ? /*#__PURE__*/_react[\"default\"].createElement(AnimationControl, {\n        animationConfig: animationConfig,\n        setLayerAnimationTime: visStateActions.setLayerAnimationTime,\n        updateAnimationSpeed: visStateActions.updateLayerAnimationSpeed,\n        toggleAnimation: visStateActions.toggleLayerAnimation,\n        isAnimatable: !animatedFilter,\n        isAnimating: isAnimating,\n        resetAnimation: reset\n      }) : null;\n    }), filter && /*#__PURE__*/_react[\"default\"].createElement(FilterAnimationController, {\n      filter: filter,\n      filterIdx: animatedFilterIdx > -1 ? animatedFilterIdx : enlargedFilterIdx,\n      setFilterAnimationTime: visStateActions.setFilterAnimationTime\n    }, function (isAnimating, start, pause, resetAnimation) {\n      return showTimeWidget ? /*#__PURE__*/_react[\"default\"].createElement(TimeWidget // TimeWidget uses React.memo, here we pass width\n      // even though it doesnt use it, to force rerender\n      , {\n        width: enlargedFilterWidth,\n        filter: filters[enlargedFilterIdx],\n        index: enlargedFilterIdx,\n        isAnyFilterAnimating: Boolean(animatedFilter),\n        datasets: datasets,\n        readOnly: readOnly,\n        showTimeDisplay: showFloatingTimeDisplay,\n        setFilterPlot: visStateActions.setFilterPlot,\n        setFilter: visStateActions.setFilter,\n        setFilterAnimationTime: visStateActions.setFilterAnimationTime,\n        setFilterAnimationWindow: visStateActions.setFilterAnimationWindow,\n        toggleAnimation: visStateActions.toggleFilterAnimation,\n        updateAnimationSpeed: visStateActions.updateFilterAnimationSpeed,\n        enlargeFilter: visStateActions.enlargeFilter,\n        resetAnimation: resetAnimation,\n        isAnimatable: !animationConfig || !animationConfig.isAnimating\n      }) : null;\n    }));\n  };\n  /* eslint-disable react/display-name */\n  // @ts-ignore\n\n  return /*#__PURE__*/(0, _react.forwardRef)(function (props, ref) {\n    return /*#__PURE__*/_react[\"default\"].createElement(BottomWidget, (0, _extends2[\"default\"])({}, props, {\n      rootRef: ref\n    }));\n  });\n  /* eslint-enable react/display-name */\n}\n/* eslint-enable complexity */","map":{"version":3,"sources":["../../src/components/bottom-widget.js"],"names":["maxWidth","BottomWidgetContainer","styled","div","props","hasPadding","theme","bottomWidgetPaddingTop","bottomWidgetPaddingRight","bottomWidgetPaddingBottom","bottomWidgetPaddingLeft","width","media","portable","FilterAnimationControllerFactory","deps","AnimationControllerFactory","AnimationController","FilterAnimationController","filter","filterIdx","setFilterAnimationTime","children","intervalBins","steps","map","x","x0","updateAnimation","animationWindow","ANIMATION_WINDOW","interval","idx","value","x1","domain","speed","isAnimating","LayerAnimationControllerFactory","LayerAnimationController","animationConfig","setLayerAnimationTime","currentTime","timeSteps","point","BottomWidgetFactory","TimeWidgetFactory","AnimationControlFactory","TimeWidget","AnimationControl","BottomWidget","datasets","filters","visStateActions","containerW","uiState","sidePanelWidth","layers","activeSidePanel","readOnly","isOpen","Boolean","enlargedFilterIdx","findIndex","f","enlarged","type","FILTER_TYPES","timeRange","animatedFilterIdx","animatedFilter","enlargedFilterWidth","animatableLayer","l","config","animation","enabled","isVisible","readyToAnimation","Array","isArray","Number","isFinite","showFloatingTimeDisplay","length","showAnimationControl","hideControl","showTimeWidget","Object","keys","Math","min","start","pause","reset","updateLayerAnimationSpeed","toggleLayerAnimation","resetAnimation","setFilterPlot","setFilter","setFilterAnimationWindow","toggleFilterAnimation","updateFilterAnimationSpeed","enlargeFilter","ref"],"mappings":"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","sourcesContent":["// Copyright (c) 2021 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport React, {useCallback, forwardRef, useMemo} from 'react';\nimport styled from 'styled-components';\nimport TimeWidgetFactory from './filters/time-widget';\nimport AnimationControlFactory from './common/animation-control/animation-control';\nimport AnimationControllerFactory from './common/animation-control/animation-controller';\nimport {ANIMATION_WINDOW, FILTER_TYPES} from 'constants/default-settings';\nimport {getIntervalBins} from 'utils/filter-utils';\nimport {media} from 'styles/media-breakpoints';\n\nconst maxWidth = 1080;\n\nconst BottomWidgetContainer = styled.div`\n  display: flex;\n  flex-direction: column;\n  padding-top: ${props => (props.hasPadding ? props.theme.bottomWidgetPaddingTop : 0)}px;\n  padding-right: ${props => (props.hasPadding ? props.theme.bottomWidgetPaddingRight : 0)}px;\n  padding-bottom: ${props => (props.hasPadding ? props.theme.bottomWidgetPaddingBottom : 0)}px;\n  padding-left: ${props => (props.hasPadding ? props.theme.bottomWidgetPaddingLeft : 0)}px;\n  pointer-events: none !important; /* prevent padding from blocking input */\n  & > * {\n    /* all children should allow input */\n    pointer-events: all;\n  }\n  width: ${props => props.width}px;\n  z-index: 1;\n  ${media.portable`padding: 0;`}\n`;\n\nFilterAnimationControllerFactory.deps = [AnimationControllerFactory];\nexport function FilterAnimationControllerFactory(AnimationController) {\n  const FilterAnimationController = ({filter, filterIdx, setFilterAnimationTime, children}) => {\n    const intervalBins = useMemo(() => getIntervalBins(filter), [filter]);\n\n    const steps = useMemo(() => (intervalBins ? intervalBins.map(x => x.x0) : null), [\n      intervalBins\n    ]);\n\n    const updateAnimation = useCallback(\n      value => {\n        switch (filter.animationWindow) {\n          case ANIMATION_WINDOW.interval:\n            const idx = value[1];\n            setFilterAnimationTime(filterIdx, 'value', [\n              intervalBins[idx].x0,\n              intervalBins[idx].x1 - 1\n            ]);\n            break;\n          default:\n            setFilterAnimationTime(filterIdx, 'value', value);\n            break;\n        }\n      },\n      [filterIdx, intervalBins, filter.animationWindow, setFilterAnimationTime]\n    );\n\n    return (\n      <AnimationController\n        key=\"filter-control\"\n        value={filter.value}\n        domain={filter.domain}\n        speed={filter.speed}\n        isAnimating={filter.isAnimating}\n        animationWindow={filter.animationWindow}\n        steps={steps}\n        updateAnimation={updateAnimation}\n        children={children}\n      />\n    );\n  };\n  return FilterAnimationController;\n}\n\nLayerAnimationControllerFactory.deps = [AnimationControllerFactory];\nexport function LayerAnimationControllerFactory(AnimationController) {\n  const LayerAnimationController = ({animationConfig, setLayerAnimationTime, children}) => (\n    <AnimationController\n      key=\"layer-control\"\n      value={animationConfig.currentTime}\n      domain={animationConfig.domain}\n      speed={animationConfig.speed}\n      isAnimating={animationConfig.isAnimating}\n      updateAnimation={setLayerAnimationTime}\n      steps={animationConfig.timeSteps}\n      animationWindow={\n        animationConfig.timeSteps ? ANIMATION_WINDOW.interval : ANIMATION_WINDOW.point\n      }\n      children={children}\n    />\n  );\n  return LayerAnimationController;\n}\n\nBottomWidgetFactory.deps = [\n  TimeWidgetFactory,\n  AnimationControlFactory,\n  FilterAnimationControllerFactory,\n  LayerAnimationControllerFactory\n];\n\n/* eslint-disable complexity */\nexport default function BottomWidgetFactory(\n  TimeWidget,\n  AnimationControl,\n  FilterAnimationController,\n  LayerAnimationController\n) {\n  const BottomWidget = props => {\n    const {\n      datasets,\n      filters,\n      animationConfig,\n      visStateActions,\n      containerW,\n      uiState,\n      sidePanelWidth,\n      layers\n    } = props;\n\n    const {activeSidePanel, readOnly} = uiState;\n    const isOpen = Boolean(activeSidePanel);\n\n    const enlargedFilterIdx = useMemo(\n      () => filters.findIndex(f => f.enlarged && f.type === FILTER_TYPES.timeRange),\n      [filters]\n    );\n    const animatedFilterIdx = useMemo(() => filters.findIndex(f => f.isAnimating), [filters]);\n    const animatedFilter = animatedFilterIdx > -1 ? filters[animatedFilterIdx] : null;\n\n    const enlargedFilterWidth = isOpen ? containerW - sidePanelWidth : containerW;\n\n    // show playback control if layers contain trip layer & at least one trip layer is visible\n    const animatableLayer = useMemo(\n      () =>\n        layers.filter(l => l.config.animation && l.config.animation.enabled && l.config.isVisible),\n      [layers]\n    );\n\n    const readyToAnimation =\n      Array.isArray(animationConfig.domain) && Number.isFinite(animationConfig.currentTime);\n    // if animation control is showing, hide time display in time slider\n    const showFloatingTimeDisplay = !animatableLayer.length;\n    const showAnimationControl =\n      animatableLayer.length && readyToAnimation && !animationConfig.hideControl;\n    const showTimeWidget = enlargedFilterIdx > -1 && Object.keys(datasets).length > 0;\n\n    // if filter is not animating, pass in enlarged filter here because\n    // animation controller needs to call reset on it\n    const filter = animatedFilter || filters[enlargedFilterIdx];\n\n    return (\n      <BottomWidgetContainer\n        width={Math.min(maxWidth, enlargedFilterWidth)}\n        className=\"bottom-widget--container\"\n        hasPadding={showAnimationControl || showTimeWidget}\n      >\n        <LayerAnimationController\n          animationConfig={animationConfig}\n          setLayerAnimationTime={visStateActions.setLayerAnimationTime}\n        >\n          {(isAnimating, start, pause, reset) =>\n            showAnimationControl ? (\n              <AnimationControl\n                animationConfig={animationConfig}\n                setLayerAnimationTime={visStateActions.setLayerAnimationTime}\n                updateAnimationSpeed={visStateActions.updateLayerAnimationSpeed}\n                toggleAnimation={visStateActions.toggleLayerAnimation}\n                isAnimatable={!animatedFilter}\n                isAnimating={isAnimating}\n                resetAnimation={reset}\n              />\n            ) : null\n          }\n        </LayerAnimationController>\n        {filter && (\n          <FilterAnimationController\n            filter={filter}\n            filterIdx={animatedFilterIdx > -1 ? animatedFilterIdx : enlargedFilterIdx}\n            setFilterAnimationTime={visStateActions.setFilterAnimationTime}\n          >\n            {(isAnimating, start, pause, resetAnimation) =>\n              showTimeWidget ? (\n                <TimeWidget\n                  // TimeWidget uses React.memo, here we pass width\n                  // even though it doesnt use it, to force rerender\n                  width={enlargedFilterWidth}\n                  filter={filters[enlargedFilterIdx]}\n                  index={enlargedFilterIdx}\n                  isAnyFilterAnimating={Boolean(animatedFilter)}\n                  datasets={datasets}\n                  readOnly={readOnly}\n                  showTimeDisplay={showFloatingTimeDisplay}\n                  setFilterPlot={visStateActions.setFilterPlot}\n                  setFilter={visStateActions.setFilter}\n                  setFilterAnimationTime={visStateActions.setFilterAnimationTime}\n                  setFilterAnimationWindow={visStateActions.setFilterAnimationWindow}\n                  toggleAnimation={visStateActions.toggleFilterAnimation}\n                  updateAnimationSpeed={visStateActions.updateFilterAnimationSpeed}\n                  enlargeFilter={visStateActions.enlargeFilter}\n                  resetAnimation={resetAnimation}\n                  isAnimatable={!animationConfig || !animationConfig.isAnimating}\n                />\n              ) : null\n            }\n          </FilterAnimationController>\n        )}\n      </BottomWidgetContainer>\n    );\n  };\n\n  /* eslint-disable react/display-name */\n  // @ts-ignore\n  return forwardRef((props, ref) => <BottomWidget {...props} rootRef={ref} />);\n  /* eslint-enable react/display-name */\n}\n/* eslint-enable complexity */\n"]},"metadata":{},"sourceType":"script"}