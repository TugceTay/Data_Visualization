{"ast":null,"code":"import { isWebGL2, assertWebGLContext } from '@luma.gl/gltools';\nimport { lumaStats } from '../init';\nimport { getKey, getKeyValue } from '../webgl-utils/constants-to-keys';\nimport { assert } from '../utils/assert';\nimport { uid } from '../utils/utils';\nimport { stubRemovedMethods } from '../utils/stub-methods';\nconst ERR_RESOURCE_METHOD_UNDEFINED = 'Resource subclass must define virtual methods';\nexport default class Resource {\n  get [Symbol.toStringTag]() {\n    return 'Resource';\n  }\n  constructor(gl) {\n    let opts = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n    assertWebGLContext(gl);\n    const {\n      id,\n      userData = {}\n    } = opts;\n    this.gl = gl;\n    this.gl2 = gl;\n    this.id = id || uid(this[Symbol.toStringTag]);\n    this.userData = userData;\n    this._bound = false;\n    this._handle = opts.handle;\n    if (this._handle === undefined) {\n      this._handle = this._createHandle();\n    }\n    this.byteLength = 0;\n    this._addStats();\n  }\n  toString() {\n    return \"\".concat(this[Symbol.toStringTag] || this.constructor.name, \"(\").concat(this.id, \")\");\n  }\n  get handle() {\n    return this._handle;\n  }\n  delete() {\n    let {\n      deleteChildren = false\n    } = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n    const children = this._handle && this._deleteHandle(this._handle);\n    if (this._handle) {\n      this._removeStats();\n    }\n    this._handle = null;\n    if (children && deleteChildren) {\n      children.filter(Boolean).forEach(child => child.delete());\n    }\n    return this;\n  }\n  bind() {\n    let funcOrHandle = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : this.handle;\n    if (typeof funcOrHandle !== 'function') {\n      this._bindHandle(funcOrHandle);\n      return this;\n    }\n    let value;\n    if (!this._bound) {\n      this._bindHandle(this.handle);\n      this._bound = true;\n      value = funcOrHandle();\n      this._bound = false;\n      this._bindHandle(null);\n    } else {\n      value = funcOrHandle();\n    }\n    return value;\n  }\n  unbind() {\n    this.bind(null);\n  }\n  getParameter(pname) {\n    let opts = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n    pname = getKeyValue(this.gl, pname);\n    assert(pname);\n    const parameters = this.constructor.PARAMETERS || {};\n    const parameter = parameters[pname];\n    if (parameter) {\n      const isWebgl2 = isWebGL2(this.gl);\n      const parameterAvailable = (!('webgl2' in parameter) || isWebgl2) && (!('extension' in parameter) || this.gl.getExtension(parameter.extension));\n      if (!parameterAvailable) {\n        const webgl1Default = parameter.webgl1;\n        const webgl2Default = 'webgl2' in parameter ? parameter.webgl2 : parameter.webgl1;\n        const defaultValue = isWebgl2 ? webgl2Default : webgl1Default;\n        return defaultValue;\n      }\n    }\n    return this._getParameter(pname, opts);\n  }\n  getParameters() {\n    let options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n    const {\n      parameters,\n      keys\n    } = options;\n    const PARAMETERS = this.constructor.PARAMETERS || {};\n    const isWebgl2 = isWebGL2(this.gl);\n    const values = {};\n    const parameterKeys = parameters || Object.keys(PARAMETERS);\n    for (const pname of parameterKeys) {\n      const parameter = PARAMETERS[pname];\n      const parameterAvailable = parameter && (!('webgl2' in parameter) || isWebgl2) && (!('extension' in parameter) || this.gl.getExtension(parameter.extension));\n      if (parameterAvailable) {\n        const key = keys ? getKey(this.gl, pname) : pname;\n        values[key] = this.getParameter(pname, options);\n        if (keys && parameter.type === 'GLenum') {\n          values[key] = getKey(this.gl, values[key]);\n        }\n      }\n    }\n    return values;\n  }\n  setParameter(pname, value) {\n    pname = getKeyValue(this.gl, pname);\n    assert(pname);\n    const parameters = this.constructor.PARAMETERS || {};\n    const parameter = parameters[pname];\n    if (parameter) {\n      const isWebgl2 = isWebGL2(this.gl);\n      const parameterAvailable = (!('webgl2' in parameter) || isWebgl2) && (!('extension' in parameter) || this.gl.getExtension(parameter.extension));\n      if (!parameterAvailable) {\n        throw new Error('Parameter not available on this platform');\n      }\n      if (parameter.type === 'GLenum') {\n        value = getKeyValue(value);\n      }\n    }\n    this._setParameter(pname, value);\n    return this;\n  }\n  setParameters(parameters) {\n    for (const pname in parameters) {\n      this.setParameter(pname, parameters[pname]);\n    }\n    return this;\n  }\n  stubRemovedMethods(className, version, methodNames) {\n    return stubRemovedMethods(this, className, version, methodNames);\n  }\n  initialize(opts) {}\n  _createHandle() {\n    throw new Error(ERR_RESOURCE_METHOD_UNDEFINED);\n  }\n  _deleteHandle() {\n    throw new Error(ERR_RESOURCE_METHOD_UNDEFINED);\n  }\n  _bindHandle(handle) {\n    throw new Error(ERR_RESOURCE_METHOD_UNDEFINED);\n  }\n  _getOptsFromHandle() {\n    throw new Error(ERR_RESOURCE_METHOD_UNDEFINED);\n  }\n  _getParameter(pname, opts) {\n    throw new Error(ERR_RESOURCE_METHOD_UNDEFINED);\n  }\n  _setParameter(pname, value) {\n    throw new Error(ERR_RESOURCE_METHOD_UNDEFINED);\n  }\n  _context() {\n    this.gl.luma = this.gl.luma || {};\n    return this.gl.luma;\n  }\n  _addStats() {\n    const name = this[Symbol.toStringTag];\n    const stats = lumaStats.get('Resource Counts');\n    stats.get('Resources Created').incrementCount();\n    stats.get(\"\".concat(name, \"s Created\")).incrementCount();\n    stats.get(\"\".concat(name, \"s Active\")).incrementCount();\n  }\n  _removeStats() {\n    const name = this[Symbol.toStringTag];\n    const stats = lumaStats.get('Resource Counts');\n    stats.get(\"\".concat(name, \"s Active\")).decrementCount();\n  }\n  _trackAllocatedMemory(bytes) {\n    let name = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : this[Symbol.toStringTag];\n    this._trackAllocatedMemoryForContext(bytes, name);\n    this._trackAllocatedMemoryForContext(bytes, name, this.gl.canvas && this.gl.canvas.id);\n    this.byteLength = bytes;\n  }\n  _trackAllocatedMemoryForContext(bytes) {\n    let name = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : this[Symbol.toStringTag];\n    let id = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : '';\n    const stats = lumaStats.get(\"Memory Usage\".concat(id));\n    stats.get('GPU Memory').addCount(bytes);\n    stats.get(\"\".concat(name, \" Memory\")).addCount(bytes);\n  }\n  _trackDeallocatedMemory() {\n    let name = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : this[Symbol.toStringTag];\n    this._trackDeallocatedMemoryForContext(name);\n    this._trackDeallocatedMemoryForContext(name, this.gl.canvas && this.gl.canvas.id);\n    this.byteLength = 0;\n  }\n  _trackDeallocatedMemoryForContext() {\n    let name = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : this[Symbol.toStringTag];\n    let id = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : '';\n    const stats = lumaStats.get(\"Memory Usage\".concat(id));\n    stats.get('GPU Memory').subtractCount(this.byteLength);\n    stats.get(\"\".concat(name, \" Memory\")).subtractCount(this.byteLength);\n  }\n}","map":{"version":3,"sources":["../../../src/classes/resource.js"],"names":["isWebGL2","assertWebGLContext","lumaStats","getKey","getKeyValue","assert","uid","stubRemovedMethods","ERR_RESOURCE_METHOD_UNDEFINED","Resource","Symbol","toStringTag","constructor","gl","opts","id","userData","gl2","_bound","_handle","handle","undefined","_createHandle","byteLength","_addStats","toString","name","delete","deleteChildren","children","_deleteHandle","_removeStats","filter","Boolean","forEach","child","bind","funcOrHandle","_bindHandle","value","unbind","getParameter","pname","parameters","PARAMETERS","parameter","isWebgl2","parameterAvailable","getExtension","extension","webgl1Default","webgl1","webgl2Default","webgl2","defaultValue","_getParameter","getParameters","options","keys","values","parameterKeys","Object","key","type","setParameter","Error","_setParameter","setParameters","className","version","methodNames","initialize","_getOptsFromHandle","_context","luma","stats","get","incrementCount","decrementCount","_trackAllocatedMemory","bytes","_trackAllocatedMemoryForContext","canvas","addCount","_trackDeallocatedMemory","_trackDeallocatedMemoryForContext","subtractCount"],"mappings":"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","sourcesContent":["import {isWebGL2, assertWebGLContext} from '@luma.gl/gltools';\nimport {lumaStats} from '../init';\nimport {getKey, getKeyValue} from '../webgl-utils/constants-to-keys';\nimport {assert} from '../utils/assert';\nimport {uid} from '../utils/utils';\nimport {stubRemovedMethods} from '../utils/stub-methods';\n\nconst ERR_RESOURCE_METHOD_UNDEFINED = 'Resource subclass must define virtual methods';\n\n// TODO - Handle context loss\n// function glGetContextLossCount(gl) {\n//   return (gl.luma && gl.luma.glCount) || 0;\n// }\n\nexport default class Resource {\n  // eslint-disable-next-line accessor-pairs\n  get [Symbol.toStringTag]() {\n    return 'Resource';\n  }\n  constructor(gl, opts = {}) {\n    assertWebGLContext(gl);\n\n    const {id, userData = {}} = opts;\n    this.gl = gl;\n    // @ts-ignore\n    this.gl2 = gl;\n    // this.ext = polyfillContext(gl);\n    this.id = id || uid(this[Symbol.toStringTag]);\n    this.userData = userData;\n    this._bound = false;\n\n    // Set the handle\n    // If handle was provided, use it, otherwise create a new handle\n\n    // TODO - Stores the handle with context loss information\n    // this.glCount = glGetContextLossCount(this.gl);\n\n    // Default VertexArray needs to be created with null handle, so compare against undefined\n    this._handle = opts.handle;\n    if (this._handle === undefined) {\n      this._handle = this._createHandle();\n    }\n\n    // Only meaningful for resources that allocate GPU memory\n    this.byteLength = 0;\n\n    this._addStats();\n  }\n\n  toString() {\n    return `${this[Symbol.toStringTag] || this.constructor.name}(${this.id})`;\n  }\n\n  get handle() {\n    // TODO - Add context loss handling\n    // Will regenerate and reinitialize the handle if necessary\n    // const glCount = glGetContextLossCount(this.gl);\n    // if (this.glCount !== glCount) {\n    //   this._handle = this._createHandle(this.opts);\n    //   this._glCount = glCount;\n    //   // Reinitialize object\n    //   this.initialize(this.opts);\n    // }\n    return this._handle;\n  }\n\n  delete({deleteChildren = false} = {}) {\n    // Delete this object, and get refs to any children\n    // @ts-ignore\n    const children = this._handle && this._deleteHandle(this._handle);\n    if (this._handle) {\n      this._removeStats();\n    }\n    this._handle = null;\n\n    // Optionally, recursively delete the children\n    // @ts-ignore\n    if (children && deleteChildren) {\n      // @ts-ignore\n      children.filter(Boolean).forEach(child => child.delete());\n    }\n\n    return this;\n  }\n\n  bind(funcOrHandle = this.handle) {\n    if (typeof funcOrHandle !== 'function') {\n      this._bindHandle(funcOrHandle);\n      return this;\n    }\n\n    let value;\n\n    if (!this._bound) {\n      this._bindHandle(this.handle);\n      this._bound = true;\n\n      value = funcOrHandle();\n\n      this._bound = false;\n      this._bindHandle(null);\n    } else {\n      value = funcOrHandle();\n    }\n\n    return value;\n  }\n\n  unbind() {\n    this.bind(null);\n  }\n\n  /**\n   * Query a Resource parameter\n   *\n   * @param {GLenum} pname\n   * @return {GLint|GLfloat|GLenum} param\n   */\n  getParameter(pname, opts = {}) {\n    pname = getKeyValue(this.gl, pname);\n    assert(pname);\n\n    // @ts-ignore\n    const parameters = this.constructor.PARAMETERS || {};\n\n    // Use parameter definitions to handle unsupported parameters\n    const parameter = parameters[pname];\n    if (parameter) {\n      const isWebgl2 = isWebGL2(this.gl);\n\n      // Check if we can query for this parameter\n      const parameterAvailable =\n        (!('webgl2' in parameter) || isWebgl2) &&\n        (!('extension' in parameter) || this.gl.getExtension(parameter.extension));\n\n      if (!parameterAvailable) {\n        const webgl1Default = parameter.webgl1;\n        const webgl2Default = 'webgl2' in parameter ? parameter.webgl2 : parameter.webgl1;\n        const defaultValue = isWebgl2 ? webgl2Default : webgl1Default;\n        return defaultValue;\n      }\n    }\n\n    // If unknown parameter - Could be a valid parameter not covered by PARAMS\n    // Attempt to query for it and let WebGL report errors\n    return this._getParameter(pname, opts);\n  }\n\n  // Many resources support a getParameter call -\n  // getParameters will get all parameters - slow but useful for debugging\n  // eslint-disable-next-line complexity\n  getParameters(options = {}) {\n    const {parameters, keys} = options;\n\n    // Get parameter definitions for this Resource\n    // @ts-ignore\n    const PARAMETERS = this.constructor.PARAMETERS || {};\n\n    const isWebgl2 = isWebGL2(this.gl);\n\n    const values = {};\n\n    // Query all parameters if no list provided\n    const parameterKeys = parameters || Object.keys(PARAMETERS);\n\n    // WEBGL limits\n    for (const pname of parameterKeys) {\n      const parameter = PARAMETERS[pname];\n\n      // Check if this parameter is available on this platform\n      const parameterAvailable =\n        parameter &&\n        (!('webgl2' in parameter) || isWebgl2) &&\n        (!('extension' in parameter) || this.gl.getExtension(parameter.extension));\n\n      if (parameterAvailable) {\n        const key = keys ? getKey(this.gl, pname) : pname;\n        values[key] = this.getParameter(pname, options);\n        if (keys && parameter.type === 'GLenum') {\n          values[key] = getKey(this.gl, values[key]);\n        }\n      }\n    }\n\n    return values;\n  }\n\n  /**\n   * Update a Resource setting\n   *\n   * @todo - cache parameter to avoid issuing WebGL calls?\n   *\n   * @param {string} pname - parameter (GL constant, value or key)\n   * @param {GLint|GLfloat|GLenum} value\n   * @return {Resource} returns self to enable chaining\n   */\n  setParameter(pname, value) {\n    pname = getKeyValue(this.gl, pname);\n    assert(pname);\n\n    // @ts-ignore\n    const parameters = this.constructor.PARAMETERS || {};\n\n    const parameter = parameters[pname];\n    if (parameter) {\n      const isWebgl2 = isWebGL2(this.gl);\n\n      // Check if this parameter is available on this platform\n      const parameterAvailable =\n        (!('webgl2' in parameter) || isWebgl2) &&\n        (!('extension' in parameter) || this.gl.getExtension(parameter.extension));\n\n      if (!parameterAvailable) {\n        throw new Error('Parameter not available on this platform');\n      }\n\n      // Handle string keys\n      if (parameter.type === 'GLenum') {\n        value = getKeyValue(value);\n      }\n    }\n\n    // If unknown parameter - Could be a valid parameter not covered by PARAMS\n    // attempt to set it and let WebGL report errors\n    this._setParameter(pname, value);\n    return this;\n  }\n\n  /*\n   * Batch update resource parameters\n   * Assumes the subclass supports a setParameter call\n   */\n  setParameters(parameters) {\n    for (const pname in parameters) {\n      this.setParameter(pname, parameters[pname]);\n    }\n    return this;\n  }\n\n  // Install stubs for removed methods\n  stubRemovedMethods(className, version, methodNames) {\n    return stubRemovedMethods(this, className, version, methodNames);\n  }\n\n  // PUBLIC VIRTUAL METHODS\n  initialize(opts) {}\n\n  // PROTECTED METHODS - These must be overridden by subclass\n  _createHandle() {\n    throw new Error(ERR_RESOURCE_METHOD_UNDEFINED);\n  }\n\n  _deleteHandle() {\n    throw new Error(ERR_RESOURCE_METHOD_UNDEFINED);\n  }\n\n  _bindHandle(handle) {\n    throw new Error(ERR_RESOURCE_METHOD_UNDEFINED);\n  }\n\n  _getOptsFromHandle() {\n    throw new Error(ERR_RESOURCE_METHOD_UNDEFINED);\n  }\n\n  /** @returns {number} */\n  _getParameter(pname, opts) {\n    throw new Error(ERR_RESOURCE_METHOD_UNDEFINED);\n  }\n\n  _setParameter(pname, value) {\n    throw new Error(ERR_RESOURCE_METHOD_UNDEFINED);\n  }\n\n  // PRIVATE METHODS\n\n  _context() {\n    this.gl.luma = this.gl.luma || {};\n    return this.gl.luma;\n  }\n\n  _addStats() {\n    const name = this[Symbol.toStringTag];\n    const stats = lumaStats.get('Resource Counts');\n\n    stats.get('Resources Created').incrementCount();\n    stats.get(`${name}s Created`).incrementCount();\n    stats.get(`${name}s Active`).incrementCount();\n  }\n\n  _removeStats() {\n    const name = this[Symbol.toStringTag];\n    const stats = lumaStats.get('Resource Counts');\n\n    stats.get(`${name}s Active`).decrementCount();\n  }\n\n  /**\n   * Track common allocated memory and memory based on particular gl context.\n   * @param {number} bytes\n   * @param {string} name\n   */\n  _trackAllocatedMemory(bytes, name = this[Symbol.toStringTag]) {\n    this._trackAllocatedMemoryForContext(bytes, name);\n    this._trackAllocatedMemoryForContext(bytes, name, this.gl.canvas && this.gl.canvas.id);\n    this.byteLength = bytes;\n  }\n\n  _trackAllocatedMemoryForContext(bytes, name = this[Symbol.toStringTag], id = '') {\n    const stats = lumaStats.get(`Memory Usage${id}`);\n    stats.get('GPU Memory').addCount(bytes);\n    stats.get(`${name} Memory`).addCount(bytes);\n  }\n\n  /**\n   * Deallocate memory for common statistic and for each gl context as well.\n   * @param {string} name\n   */\n  _trackDeallocatedMemory(name = this[Symbol.toStringTag]) {\n    this._trackDeallocatedMemoryForContext(name);\n    this._trackDeallocatedMemoryForContext(name, this.gl.canvas && this.gl.canvas.id);\n    this.byteLength = 0;\n  }\n\n  _trackDeallocatedMemoryForContext(name = this[Symbol.toStringTag], id = '') {\n    const stats = lumaStats.get(`Memory Usage${id}`);\n\n    stats.get('GPU Memory').subtractCount(this.byteLength);\n    stats.get(`${name} Memory`).subtractCount(this.byteLength);\n  }\n}\n"]},"metadata":{},"sourceType":"module"}