{"ast":null,"code":"import _defineProperty from \"@babel/runtime/helpers/esm/defineProperty\";\nimport _classCallCheck from \"@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"@babel/runtime/helpers/esm/createClass\";\nimport _possibleConstructorReturn from \"@babel/runtime/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"@babel/runtime/helpers/esm/getPrototypeOf\";\nimport _get from \"@babel/runtime/helpers/esm/get\";\nimport _inherits from \"@babel/runtime/helpers/esm/inherits\";\nfunction ownKeys(object, enumerableOnly) {\n  var keys = Object.keys(object);\n  if (Object.getOwnPropertySymbols) {\n    var symbols = Object.getOwnPropertySymbols(object);\n    if (enumerableOnly) symbols = symbols.filter(function (sym) {\n      return Object.getOwnPropertyDescriptor(object, sym).enumerable;\n    });\n    keys.push.apply(keys, symbols);\n  }\n  return keys;\n}\nfunction _objectSpread(target) {\n  for (var i = 1; i < arguments.length; i++) {\n    var source = arguments[i] != null ? arguments[i] : {};\n    if (i % 2) {\n      ownKeys(Object(source), true).forEach(function (key) {\n        _defineProperty(target, key, source[key]);\n      });\n    } else if (Object.getOwnPropertyDescriptors) {\n      Object.defineProperties(target, Object.getOwnPropertyDescriptors(source));\n    } else {\n      ownKeys(Object(source)).forEach(function (key) {\n        Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key));\n      });\n    }\n  }\n  return target;\n}\nimport LayersPass from './layers-pass';\nimport { withParameters } from '@luma.gl/core';\nvar PICKING_PARAMETERS = {\n  blendFunc: [1, 0, 32771, 0],\n  blendEquation: 32774\n};\nvar PickLayersPass = function (_LayersPass) {\n  _inherits(PickLayersPass, _LayersPass);\n  function PickLayersPass() {\n    _classCallCheck(this, PickLayersPass);\n    return _possibleConstructorReturn(this, _getPrototypeOf(PickLayersPass).apply(this, arguments));\n  }\n  _createClass(PickLayersPass, [{\n    key: \"render\",\n    value: function render(props) {\n      if (props.pickingFBO) {\n        this._drawPickingBuffer(props);\n      } else {\n        _get(_getPrototypeOf(PickLayersPass.prototype), \"render\", this).call(this, props);\n      }\n    }\n  }, {\n    key: \"_drawPickingBuffer\",\n    value: function _drawPickingBuffer(_ref) {\n      var _this = this;\n      var layers = _ref.layers,\n        layerFilter = _ref.layerFilter,\n        viewports = _ref.viewports,\n        onViewportActive = _ref.onViewportActive,\n        pickingFBO = _ref.pickingFBO,\n        _ref$deviceRect = _ref.deviceRect,\n        x = _ref$deviceRect.x,\n        y = _ref$deviceRect.y,\n        width = _ref$deviceRect.width,\n        height = _ref$deviceRect.height,\n        _ref$pass = _ref.pass,\n        pass = _ref$pass === void 0 ? 'picking' : _ref$pass,\n        redrawReason = _ref.redrawReason,\n        pickZ = _ref.pickZ;\n      var gl = this.gl;\n      this.pickZ = pickZ;\n      return withParameters(gl, _objectSpread({\n        scissorTest: true,\n        scissor: [x, y, width, height],\n        clearColor: [0, 0, 0, 0],\n        depthMask: true,\n        depthTest: true,\n        depthRange: [0, 1],\n        colorMask: [true, true, true, true]\n      }, PICKING_PARAMETERS, {\n        blend: !pickZ\n      }), function () {\n        _get(_getPrototypeOf(PickLayersPass.prototype), \"render\", _this).call(_this, {\n          target: pickingFBO,\n          layers: layers,\n          layerFilter: layerFilter,\n          viewports: viewports,\n          onViewportActive: onViewportActive,\n          pass: pass,\n          redrawReason: redrawReason\n        });\n      });\n    }\n  }, {\n    key: \"shouldDrawLayer\",\n    value: function shouldDrawLayer(layer) {\n      return layer.props.pickable;\n    }\n  }, {\n    key: \"getModuleParameters\",\n    value: function getModuleParameters() {\n      return {\n        pickingActive: 1,\n        pickingAttribute: this.pickZ,\n        lightSources: {}\n      };\n    }\n  }, {\n    key: \"getLayerParameters\",\n    value: function getLayerParameters(layer, layerIndex) {\n      var pickParameters = this.pickZ ? {\n        blend: false\n      } : _objectSpread({}, PICKING_PARAMETERS, {\n        blend: true,\n        blendColor: [0, 0, 0, (layerIndex + 1) / 255]\n      });\n      return Object.assign({}, layer.props.parameters, pickParameters);\n    }\n  }]);\n  return PickLayersPass;\n}(LayersPass);\nexport { PickLayersPass as default };","map":{"version":3,"sources":["../../../src/passes/pick-layers-pass.js"],"names":["LayersPass","withParameters","PICKING_PARAMETERS","blendFunc","blendEquation","PickLayersPass","props","pickingFBO","_drawPickingBuffer","layers","layerFilter","viewports","onViewportActive","deviceRect","x","y","width","height","pass","redrawReason","pickZ","gl","scissorTest","scissor","clearColor","depthMask","depthTest","depthRange","colorMask","blend","target","layer","pickable","pickingActive","pickingAttribute","lightSources","layerIndex","pickParameters","blendColor","Object","assign","parameters"],"mappings":"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","sourcesContent":["import LayersPass from './layers-pass';\nimport {withParameters} from '@luma.gl/core';\nimport GL from '@luma.gl/constants';\n\nconst PICKING_PARAMETERS = {\n  blendFunc: [GL.ONE, GL.ZERO, GL.CONSTANT_ALPHA, GL.ZERO],\n  blendEquation: GL.FUNC_ADD\n};\n\nexport default class PickLayersPass extends LayersPass {\n  render(props) {\n    if (props.pickingFBO) {\n      this._drawPickingBuffer(props);\n    } else {\n      super.render(props);\n    }\n  }\n\n  // Private\n  // Draws list of layers and viewports into the picking buffer\n  // Note: does not sample the buffer, that has to be done by the caller\n  _drawPickingBuffer({\n    layers,\n    layerFilter,\n    viewports,\n    onViewportActive,\n    pickingFBO,\n    deviceRect: {x, y, width, height},\n    pass = 'picking',\n    redrawReason,\n    pickZ\n  }) {\n    const gl = this.gl;\n    this.pickZ = pickZ;\n\n    // Make sure we clear scissor test and fbo bindings in case of exceptions\n    // We are only interested in one pixel, no need to render anything else\n    // Note that the callback here is called synchronously.\n    // Set blend mode for picking\n    // always overwrite existing pixel with [r,g,b,layerIndex]\n    return withParameters(\n      gl,\n      {\n        scissorTest: true,\n        scissor: [x, y, width, height],\n        clearColor: [0, 0, 0, 0],\n        // When used as Mapbox custom layer, the context state may be dirty\n        // TODO - Remove when mapbox fixes this issue\n        // https://github.com/mapbox/mapbox-gl-js/issues/7801\n        depthMask: true,\n        depthTest: true,\n        depthRange: [0, 1],\n        colorMask: [true, true, true, true],\n        // Blending\n        ...PICKING_PARAMETERS,\n        blend: !pickZ\n      },\n      () => {\n        super.render({\n          target: pickingFBO,\n          layers,\n          layerFilter,\n          viewports,\n          onViewportActive,\n          pass,\n          redrawReason\n        });\n      }\n    );\n  }\n\n  // PRIVATE\n  shouldDrawLayer(layer) {\n    return layer.props.pickable;\n  }\n\n  getModuleParameters() {\n    return {\n      pickingActive: 1,\n      pickingAttribute: this.pickZ,\n      // turn off lighting by adding empty light source object\n      // lights shader module relies on the `lightSources` to turn on/off lighting\n      lightSources: {}\n    };\n  }\n\n  getLayerParameters(layer, layerIndex) {\n    // These will override any layer parameters\n    const pickParameters = this.pickZ\n      ? {blend: false}\n      : {...PICKING_PARAMETERS, blend: true, blendColor: [0, 0, 0, (layerIndex + 1) / 255]};\n\n    // Override layer parameters with pick parameters\n    return Object.assign({}, layer.props.parameters, pickParameters);\n  }\n}\n"]},"metadata":{},"sourceType":"module"}