{"ast":null,"code":"\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.getDefaultLayerGroupVisibility = getDefaultLayerGroupVisibility;\nexports.isValidStyleUrl = isValidStyleUrl;\nexports.getStyleDownloadUrl = getStyleDownloadUrl;\nexports.getStyleImageIcon = getStyleImageIcon;\nexports.scaleMapStyleByResolution = scaleMapStyleByResolution;\nexports.mergeLayerGroupVisibility = mergeLayerGroupVisibility;\nexports.editBottomMapStyle = exports.editTopMapStyle = void 0;\nvar _defineProperty2 = _interopRequireDefault(require(\"@babel/runtime/helpers/defineProperty\"));\nvar _lodash = _interopRequireDefault(require(\"lodash.memoize\"));\nvar _lodash2 = _interopRequireDefault(require(\"lodash.clonedeep\"));\nvar _defaultSettings = require(\"../../constants/default-settings\");\nfunction ownKeys(object, enumerableOnly) {\n  var keys = Object.keys(object);\n  if (Object.getOwnPropertySymbols) {\n    var symbols = Object.getOwnPropertySymbols(object);\n    if (enumerableOnly) symbols = symbols.filter(function (sym) {\n      return Object.getOwnPropertyDescriptor(object, sym).enumerable;\n    });\n    keys.push.apply(keys, symbols);\n  }\n  return keys;\n}\nfunction _objectSpread(target) {\n  for (var i = 1; i < arguments.length; i++) {\n    var source = arguments[i] != null ? arguments[i] : {};\n    if (i % 2) {\n      ownKeys(Object(source), true).forEach(function (key) {\n        (0, _defineProperty2[\"default\"])(target, key, source[key]);\n      });\n    } else if (Object.getOwnPropertyDescriptors) {\n      Object.defineProperties(target, Object.getOwnPropertyDescriptors(source));\n    } else {\n      ownKeys(Object(source)).forEach(function (key) {\n        Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key));\n      });\n    }\n  }\n  return target;\n}\nvar mapUrlRg = /^mapbox:\\/\\/styles\\/[-a-z0-9]{2,256}\\/[-a-z0-9]{2,256}/;\nvar httpRg = /^(?=(http:|https:))/;\nfunction getDefaultLayerGroupVisibility(_ref) {\n  var _ref$layerGroups = _ref.layerGroups,\n    layerGroups = _ref$layerGroups === void 0 ? [] : _ref$layerGroups;\n  return layerGroups.reduce(function (accu, layer) {\n    return _objectSpread(_objectSpread({}, accu), {}, (0, _defineProperty2[\"default\"])({}, layer.slug, layer.defaultVisibility));\n  }, {});\n}\nvar resolver = function resolver(_ref2) {\n  var id = _ref2.id,\n    mapStyle = _ref2.mapStyle,\n    _ref2$visibleLayerGro = _ref2.visibleLayerGroups,\n    visibleLayerGroups = _ref2$visibleLayerGro === void 0 ? {} : _ref2$visibleLayerGro;\n  return \"\".concat(id, \":\").concat(Object.keys(visibleLayerGroups).filter(function (d) {\n    return visibleLayerGroups[d];\n  }).sort().join('-'));\n};\n/**\n * Edit preset map style to keep only visible layers\n *\n * @param {Object} mapStyle - preset map style\n * @param {Object} visibleLayerGroups - visible layers of top map\n * @returns {Object} top map style\n */\n\nvar editTopMapStyle = (0, _lodash[\"default\"])(function (_ref3) {\n  var id = _ref3.id,\n    mapStyle = _ref3.mapStyle,\n    visibleLayerGroups = _ref3.visibleLayerGroups;\n  var visibleFilters = (mapStyle.layerGroups || []).filter(function (lg) {\n    return visibleLayerGroups[lg.slug];\n  }).map(function (lg) {\n    return lg.filter;\n  }); // if top map\n  // keep only visible layers\n\n  var filteredLayers = mapStyle.style.layers.filter(function (layer) {\n    return visibleFilters.some(function (match) {\n      return match(layer);\n    });\n  });\n  return _objectSpread(_objectSpread({}, mapStyle.style), {}, {\n    layers: filteredLayers\n  });\n}, resolver);\n/**\n * Edit preset map style to filter out invisible layers\n *\n * @param {Object} mapStyle - preset map style\n * @param {Object} visibleLayerGroups - visible layers of bottom map\n * @returns {Object} bottom map style\n */\n\nexports.editTopMapStyle = editTopMapStyle;\nvar editBottomMapStyle = (0, _lodash[\"default\"])(function (_ref4) {\n  var id = _ref4.id,\n    mapStyle = _ref4.mapStyle,\n    visibleLayerGroups = _ref4.visibleLayerGroups;\n  var invisibleFilters = (mapStyle.layerGroups || []).filter(function (lg) {\n    return !visibleLayerGroups[lg.slug];\n  }).map(function (lg) {\n    return lg.filter;\n  }); // if bottom map\n  // filter out invisible layers\n\n  var filteredLayers = mapStyle.style.layers.filter(function (layer) {\n    return invisibleFilters.every(function (match) {\n      return !match(layer);\n    });\n  });\n  return _objectSpread(_objectSpread({}, mapStyle.style), {}, {\n    layers: filteredLayers\n  });\n}, resolver); // valid style url\n// mapbox://styles/uberdata/cjfyl03kp1tul2smf5v2tbdd4\n// lowercase letters, numbers and dashes only.\n\nexports.editBottomMapStyle = editBottomMapStyle;\nfunction isValidStyleUrl(url) {\n  return typeof url === 'string' && Boolean(url.match(mapUrlRg) || url.match(httpRg));\n}\nfunction getStyleDownloadUrl(styleUrl, accessToken, mapboxApiUrl) {\n  if (styleUrl.startsWith('http')) {\n    return styleUrl;\n  } // mapbox://styles/jckr/cjhcl0lxv13di2rpfoytdbdyj\n\n  if (styleUrl.startsWith('mapbox://styles')) {\n    var styleId = styleUrl.replace('mapbox://styles/', ''); // https://api.mapbox.com/styles/v1/heshan0131/cjg1bfumo1cwm2rlrjxkinfgw?pluginName=Keplergl&access_token=<token>\n\n    return \"\".concat(mapboxApiUrl || _defaultSettings.DEFAULT_MAPBOX_API_URL, \"/styles/v1/\").concat(styleId, \"?pluginName=Keplergl&access_token=\").concat(accessToken);\n  } // style url not recognized\n\n  return null;\n}\n/**\n * Generate static map image from style Url to be used as icon\n * @param {Object} param\n * @param {string} param.styleUrl\n * @param {string} param.mapboxApiAccessToken\n * @param {string} param.mapboxApiUrl\n * @param {Object} param.mapState\n * @param {number} param.mapW\n * @param {number} param.mapH\n */\n\nfunction getStyleImageIcon(_ref5) {\n  var styleUrl = _ref5.styleUrl,\n    mapboxApiAccessToken = _ref5.mapboxApiAccessToken,\n    _ref5$mapboxApiUrl = _ref5.mapboxApiUrl,\n    mapboxApiUrl = _ref5$mapboxApiUrl === void 0 ? _defaultSettings.DEFAULT_MAPBOX_API_URL : _ref5$mapboxApiUrl,\n    _ref5$mapState = _ref5.mapState,\n    mapState = _ref5$mapState === void 0 ? {\n      longitude: -122.3391,\n      latitude: 37.7922,\n      zoom: 9\n    } : _ref5$mapState,\n    _ref5$mapW = _ref5.mapW,\n    mapW = _ref5$mapW === void 0 ? 400 : _ref5$mapW,\n    _ref5$mapH = _ref5.mapH,\n    mapH = _ref5$mapH === void 0 ? 300 : _ref5$mapH;\n  var styleId = styleUrl.replace('mapbox://styles/', '');\n  return \"\".concat(mapboxApiUrl, \"/styles/v1/\").concat(styleId, \"/static/\") + \"\".concat(mapState.longitude, \",\").concat(mapState.latitude, \",\").concat(mapState.zoom, \",0,0/\") + \"\".concat(mapW, \"x\").concat(mapH) + \"?access_token=\".concat(mapboxApiAccessToken, \"&logo=false&attribution=false\");\n}\nfunction scaleMapStyleByResolution(mapboxStyle, scale) {\n  if (scale !== 1 && mapboxStyle) {\n    var labelLayerGroup = _defaultSettings.DEFAULT_LAYER_GROUPS.find(function (lg) {\n      return lg.slug === 'label';\n    }); // @ts-ignore\n\n    var labelLayerFilter = labelLayerGroup.filter;\n    var zoomOffset = Math.log2(scale);\n    var copyStyle = (0, _lodash2[\"default\"])(mapboxStyle);\n    (copyStyle.layers || []).forEach(function (d) {\n      // edit minzoom and maxzoom\n      if (d.maxzoom) {\n        d.maxzoom = Math.max(d.maxzoom + zoomOffset, 1);\n      }\n      if (d.minzoom) {\n        d.minzoom = Math.max(d.minzoom + zoomOffset, 1);\n      } // edit text size\n\n      if (labelLayerFilter(d)) {\n        if (d.layout && d.layout['text-size'] && Array.isArray(d.layout['text-size'].stops)) {\n          d.layout['text-size'].stops.forEach(function (stop) {\n            // zoom\n            stop[0] = Math.max(stop[0] + zoomOffset, 1); // size\n\n            stop[1] *= scale;\n          });\n        }\n      }\n    });\n    return copyStyle;\n  }\n  return mapboxStyle;\n}\n/**\n * When switch to a new style, try to keep current layer group visibility\n * by merging default and current\n * @param {Object} defaultLayerGroup\n * @param {Object} currentLayerGroup\n * @return {Object} mergedLayerGroups\n */\n\nfunction mergeLayerGroupVisibility(defaultLayerGroup, currentLayerGroup) {\n  return Object.keys(defaultLayerGroup).reduce(function (accu, key) {\n    return _objectSpread(_objectSpread({}, accu), currentLayerGroup.hasOwnProperty(key) ? (0, _defineProperty2[\"default\"])({}, key, currentLayerGroup[key]) : {});\n  }, defaultLayerGroup);\n}","map":{"version":3,"sources":["../../../src/utils/map-style-utils/mapbox-gl-style-editor.js"],"names":["mapUrlRg","httpRg","getDefaultLayerGroupVisibility","layerGroups","reduce","accu","layer","slug","defaultVisibility","resolver","id","mapStyle","visibleLayerGroups","keys","filter","d","sort","join","editTopMapStyle","visibleFilters","lg","map","filteredLayers","style","layers","some","match","editBottomMapStyle","invisibleFilters","every","isValidStyleUrl","url","Boolean","getStyleDownloadUrl","styleUrl","accessToken","mapboxApiUrl","startsWith","styleId","replace","DEFAULT_MAPBOX_API_URL","getStyleImageIcon","mapboxApiAccessToken","mapState","longitude","latitude","zoom","mapW","mapH","scaleMapStyleByResolution","mapboxStyle","scale","labelLayerGroup","find","labelLayerFilter","zoomOffset","Math","log2","copyStyle","forEach","maxzoom","max","minzoom","layout","Array","isArray","stops","stop","mergeLayerGroupVisibility","defaultLayerGroup","currentLayerGroup","key","hasOwnProperty"],"mappings":"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","sourcesContent":["// Copyright (c) 2021 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport memoize from 'lodash.memoize';\nimport clondDeep from 'lodash.clonedeep';\nimport {DEFAULT_LAYER_GROUPS, DEFAULT_MAPBOX_API_URL} from 'constants/default-settings';\n\nconst mapUrlRg = /^mapbox:\\/\\/styles\\/[-a-z0-9]{2,256}\\/[-a-z0-9]{2,256}/;\nconst httpRg = /^(?=(http:|https:))/;\n\nexport function getDefaultLayerGroupVisibility({layerGroups = []}) {\n  return layerGroups.reduce(\n    (accu, layer) => ({\n      ...accu,\n      [layer.slug]: layer.defaultVisibility\n    }),\n    {}\n  );\n}\n\nconst resolver = ({id, mapStyle, visibleLayerGroups = {}}) =>\n  `${id}:${Object.keys(visibleLayerGroups)\n    .filter(d => visibleLayerGroups[d])\n    .sort()\n    .join('-')}`;\n\n/**\n * Edit preset map style to keep only visible layers\n *\n * @param {Object} mapStyle - preset map style\n * @param {Object} visibleLayerGroups - visible layers of top map\n * @returns {Object} top map style\n */\nexport const editTopMapStyle = memoize(({id, mapStyle, visibleLayerGroups}) => {\n  const visibleFilters = (mapStyle.layerGroups || [])\n    .filter(lg => visibleLayerGroups[lg.slug])\n    .map(lg => lg.filter);\n\n  // if top map\n  // keep only visible layers\n  const filteredLayers = mapStyle.style.layers.filter(layer =>\n    visibleFilters.some(match => match(layer))\n  );\n\n  return {\n    ...mapStyle.style,\n    layers: filteredLayers\n  };\n}, resolver);\n\n/**\n * Edit preset map style to filter out invisible layers\n *\n * @param {Object} mapStyle - preset map style\n * @param {Object} visibleLayerGroups - visible layers of bottom map\n * @returns {Object} bottom map style\n */\nexport const editBottomMapStyle = memoize(({id, mapStyle, visibleLayerGroups}) => {\n  const invisibleFilters = (mapStyle.layerGroups || [])\n    .filter(lg => !visibleLayerGroups[lg.slug])\n    .map(lg => lg.filter);\n\n  // if bottom map\n  // filter out invisible layers\n  const filteredLayers = mapStyle.style.layers.filter(layer =>\n    invisibleFilters.every(match => !match(layer))\n  );\n\n  return {\n    ...mapStyle.style,\n    layers: filteredLayers\n  };\n}, resolver);\n\n// valid style url\n// mapbox://styles/uberdata/cjfyl03kp1tul2smf5v2tbdd4\n// lowercase letters, numbers and dashes only.\nexport function isValidStyleUrl(url) {\n  return typeof url === 'string' && Boolean(url.match(mapUrlRg) || url.match(httpRg));\n}\n\nexport function getStyleDownloadUrl(styleUrl, accessToken, mapboxApiUrl) {\n  if (styleUrl.startsWith('http')) {\n    return styleUrl;\n  }\n\n  // mapbox://styles/jckr/cjhcl0lxv13di2rpfoytdbdyj\n  if (styleUrl.startsWith('mapbox://styles')) {\n    const styleId = styleUrl.replace('mapbox://styles/', '');\n\n    // https://api.mapbox.com/styles/v1/heshan0131/cjg1bfumo1cwm2rlrjxkinfgw?pluginName=Keplergl&access_token=<token>\n    return `${mapboxApiUrl ||\n      DEFAULT_MAPBOX_API_URL}/styles/v1/${styleId}?pluginName=Keplergl&access_token=${accessToken}`;\n  }\n\n  // style url not recognized\n  return null;\n}\n\n/**\n * Generate static map image from style Url to be used as icon\n * @param {Object} param\n * @param {string} param.styleUrl\n * @param {string} param.mapboxApiAccessToken\n * @param {string} param.mapboxApiUrl\n * @param {Object} param.mapState\n * @param {number} param.mapW\n * @param {number} param.mapH\n */\nexport function getStyleImageIcon({\n  styleUrl,\n  mapboxApiAccessToken,\n  mapboxApiUrl = DEFAULT_MAPBOX_API_URL,\n  mapState = {\n    longitude: -122.3391,\n    latitude: 37.7922,\n    zoom: 9\n  },\n  mapW = 400,\n  mapH = 300\n}) {\n  const styleId = styleUrl.replace('mapbox://styles/', '');\n\n  return (\n    `${mapboxApiUrl}/styles/v1/${styleId}/static/` +\n    `${mapState.longitude},${mapState.latitude},${mapState.zoom},0,0/` +\n    `${mapW}x${mapH}` +\n    `?access_token=${mapboxApiAccessToken}&logo=false&attribution=false`\n  );\n}\n\nexport function scaleMapStyleByResolution(mapboxStyle, scale) {\n  if (scale !== 1 && mapboxStyle) {\n    const labelLayerGroup = DEFAULT_LAYER_GROUPS.find(lg => lg.slug === 'label');\n    // @ts-ignore\n    const {filter: labelLayerFilter} = labelLayerGroup;\n    const zoomOffset = Math.log2(scale);\n\n    const copyStyle = clondDeep(mapboxStyle);\n    (copyStyle.layers || []).forEach(d => {\n      // edit minzoom and maxzoom\n      if (d.maxzoom) {\n        d.maxzoom = Math.max(d.maxzoom + zoomOffset, 1);\n      }\n\n      if (d.minzoom) {\n        d.minzoom = Math.max(d.minzoom + zoomOffset, 1);\n      }\n\n      // edit text size\n      if (labelLayerFilter(d)) {\n        if (d.layout && d.layout['text-size'] && Array.isArray(d.layout['text-size'].stops)) {\n          d.layout['text-size'].stops.forEach(stop => {\n            // zoom\n            stop[0] = Math.max(stop[0] + zoomOffset, 1);\n            // size\n            stop[1] *= scale;\n          });\n        }\n      }\n    });\n\n    return copyStyle;\n  }\n\n  return mapboxStyle;\n}\n\n/**\n * When switch to a new style, try to keep current layer group visibility\n * by merging default and current\n * @param {Object} defaultLayerGroup\n * @param {Object} currentLayerGroup\n * @return {Object} mergedLayerGroups\n */\nexport function mergeLayerGroupVisibility(defaultLayerGroup, currentLayerGroup) {\n  return Object.keys(defaultLayerGroup).reduce(\n    (accu, key) => ({\n      ...accu,\n      ...(currentLayerGroup.hasOwnProperty(key) ? {[key]: currentLayerGroup[key]} : {})\n    }),\n    defaultLayerGroup\n  );\n}\n"]},"metadata":{},"sourceType":"script"}